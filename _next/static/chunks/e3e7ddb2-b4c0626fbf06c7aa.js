"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[155],{29410:(e,t,i)=>{i.d(t,{M:()=>t_});var s,r,n,a,h,o,p,l,g,d,u,c,S,f,m,y,P,I,C,w,_,T,B,b,v,k,F,A,M,O,E,U,K,L,R,z,D,V,H,G,Z,Y,N,X,j,q,Q,$,W,J,ee,et,ei,es,er,en,ea,eh,eo,ep,el,eg,ed,eu,ec,eS,ef,em,ey,eP,eI,eC,ew,e_,ex=i(42812),eT=i(75749),eB=i(85678),eb=i(99494),ev=i(37836),ek=i(95479),eF=i(79694),eA=i(51202),eM=i(45502),eO=i(36652),eE=i(67348),eU=i(4306),eK=i(8842),eL=i(97056),eR=i(712),ez=i(21334),eD=i(47802),eV=i(86810),eH=i(54085),eG=i(23072),eZ=i(19320),eY=i(44885),eN=i(78642),eX=i(38504),ej=i(95010),eq=i(38496),eQ=i(96132),e$=i(96205),eW=i(2695),eJ=i(13130),e0=i(71407),e1=i(40596),e2=i(9250),e5=i(42981),e4=i(62197),e3=i(55909),e8=i(2163),e9=i(83190),e7=i(17990),e6=i(13886),te=i(38343),tt=i(2062),ti=i(42717),ts=i(75783),tr=Object.create,tn=Object.defineProperty,ta=Object.getOwnPropertyDescriptor,th=(e,t)=>(t=Symbol[e])?t:Symbol.for("Symbol."+e),to=e=>{throw TypeError(e)},tp=(e,t,i)=>t in e?tn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,tl=(e,t)=>tn(e,"name",{value:t,configurable:!0}),tg=["class","method","getter","setter","accessor","field","value","get","set"],td=e=>void 0!==e&&"function"!=typeof e?to("Function expected"):e,tu=(e,t,i,s,r)=>({kind:tg[e],name:t,metadata:s,addInitializer:e=>i._?to("Already initialized"):r.push(td(e||null))}),tc=(e,t)=>tp(t,th("metadata"),e[3]),tS=(e,t,i,s)=>{for(var r=0,n=e[t>>1],a=n&&n.length;r<a;r++)1&t?n[r].call(i):s=n[r].call(i,s);return s},tf=(e,t,i,s,r,n)=>{var a,h,o,p,l,g=7&t,d=!!(8&t),u=!!(16&t),c=g>3?e.length+1:g?d?1:2:0,S=tg[g+5],f=g>3&&(e[c-1]=[]),m=e[c]||(e[c]=[]),y=g&&(u||d||(r=r.prototype),g<5&&(g>3||!u)&&ta(g<4?r:{get[i](){return tI(this,n)},set[i](x){return tC(this,n,x)}},i));g?u&&g<4&&tl(n,(g>2?"set ":g>1?"get ":"")+i):tl(r,i);for(var P=s.length-1;P>=0;P--)p=tu(g,i,o={},e[3],m),g&&(p.static=d,p.private=u,l=p.access={has:u?e=>tP(r,e):e=>i in e},3^g&&(l.get=u?e=>(1^g?tI:tw)(e,r,4^g?n:y.get):e=>e[i]),g>2&&(l.set=u?(e,t)=>tC(e,r,t,4^g?n:y.set):(e,t)=>e[i]=t)),h=(0,s[P])(g?g<4?u?n:y[S]:g>4?void 0:{get:y.get,set:y.set}:r,p),o._=1,4^g||void 0===h?td(h)&&(g>4?f.unshift(h):g?u?n=h:y[S]=h:r=h):"object"!=typeof h||null===h?to("Object expected"):(td(a=h.get)&&(y.get=a),td(a=h.set)&&(y.set=a),td(a=h.init)&&f.unshift(a));return g||tc(e,r),y&&tn(r,i,y),u?4^g?n:y:r},tm=(e,t,i)=>tp(e,"symbol"!=typeof t?t+"":t,i),ty=(e,t,i)=>t.has(e)||to("Cannot "+i),tP=(e,t)=>Object(t)!==t?to('Cannot use the "in" operator on this value'):e.has(t),tI=(e,t,i)=>(ty(e,t,"read from private field"),i?i.call(e):t.get(e)),tC=(e,t,i,s)=>(ty(e,t,"write to private field"),s?s.call(e,i):t.set(e,i),i),tw=(e,t,i)=>(ty(e,t,"access private method"),i);class t_ extends(ew=ev,eC=[ex.Fl],eI=[ex.Fl],eP=[ex.Fl],ey=[ex.Fl],em=[ex.Fl],ef=[ex.Fl],eS=[ex.Fl],ec=[ex.Fl],eu=[ex.Fl],ed=[ex.Fl],eg=[ex.Fl],el=[ex.Fl],ep=[ex.Fl],eo=[ex.Fl],eh=[ex.Fl],ea=[ex.Fl],en=[ex.Fl],er=[ex.Fl],es=[ex.Fl],ei=[ex.Fl],et=[ex.Fl],ee=[ex.Fl],J=[ex.Fl],W=[ex.Fl],$=[ex.Fl],Q=[ex.Fl],q=[ex.Fl],j=[ex.Fl],X=[ex.Fl],N=[ex.Fl],Y=[ex.Fl],Z=[ex.Fl],G=[ex.Fl],H=[ex.Fl],V=[ex.Fl],D=[ex.Fl],z=[ex.Fl],R=[ex.Fl],L=[ex.Fl],K=[ex.Fl],U=[ex.Fl],E=[ex.Fl],O=[ex.Fl],M=[ex.Fl],A=[ex.Fl],F=[ex.Fl],k=[ex.Fl],v=[ex.Fl],b=[ex.Fl],B=[ex.Fl],T=[ex.Fl],_=[ex.Fl],w=[ex.Fl],C=[ex.Fl],I=[ex.Fl],P=[ex.Fl],y=[ex.Fl],m=[ex.Fl],f=[ex.Fl],S=[ex.Fl],c=[ex.Fl],u=[ex.Fl],d=[ex.Fl],g=[ex.Fl],l=[(0,ex.Fl)({isEqual:(e,t)=>e.equals(t)})],p=[ex.Fl],o=[ex.Fl],h=[ex.Fl],a=[eb.ak],n=[eb.ak],r=[eb.ak],s=[eb.ak],ew){constructor({store:e,user:t,shapeUtils:i,bindingUtils:s,tools:r,getContainer:n,cameraOptions:a,initialState:h,autoFocus:o,inferDarkMode:p,options:l,isShapeHidden:g}){super(),tS(e_,5,this),tm(this,"_isShapeHiddenPredicate"),tm(this,"options"),tm(this,"contextId",(0,eb.EL)()),tm(this,"store"),tm(this,"root"),tm(this,"disposables",new Set),tm(this,"isDisposed",!1),tm(this,"_tickManager"),tm(this,"snaps"),tm(this,"timers",eL.r.forContext(this.contextId)),tm(this,"user"),tm(this,"textMeasure"),tm(this,"environment",eU.a),tm(this,"scribbles"),tm(this,"sideEffects"),tm(this,"edgeScrollManager"),tm(this,"focusManager"),tm(this,"getContainer"),tm(this,"shapeUtils"),tm(this,"styleProps"),tm(this,"bindingUtils"),tm(this,"history"),tm(this,"_shouldIgnoreShapeLock",!1),tm(this,"_crashingError",null),tm(this,"_isChangingStyleTimeout",-1),tm(this,"menus",eK.h.forContext(this.contextId)),tm(this,"_cameraOptions",(0,ex.cn)("camera options",eO.B8)),tm(this,"_viewportAnimation",null),tm(this,"_willSetInitialBounds",!0),tm(this,"_isLockedOnFollowingUser",(0,ex.cn)("isLockedOnFollowingUser",!1)),tm(this,"_cameraState",(0,ex.cn)("camera state","idle")),tm(this,"_cameraStateTimeoutRemaining",0),tm(this,"_currentPageShapeIds"),tm(this,"_parentIdsToChildIds"),tm(this,"animatingShapes",new Map),tm(this,"externalAssetContentHandlers",{file:null,url:null}),tm(this,"temporaryAssetPreview",new Map),tm(this,"externalContentHandlers",{text:null,files:null,embed:null,"svg-text":null,url:null}),tm(this,"inputs",{originPagePoint:new eV.B,originScreenPoint:new eV.B,previousPagePoint:new eV.B,previousScreenPoint:new eV.B,currentPagePoint:new eV.B,currentScreenPoint:new eV.B,keys:new Set,buttons:new Set,isPen:!1,shiftKey:!1,metaKey:!1,ctrlKey:!1,altKey:!1,isDragging:!1,isPointing:!1,isPinching:!1,isEditing:!1,isPanning:!1,isSpacebarPanning:!1,pointerVelocity:new eV.B}),tm(this,"_clickManager",new e4.o(this)),tm(this,"_prevCursor","default"),tm(this,"_shiftKeyTimeout",-1),tm(this,"_altKeyTimeout",-1),tm(this,"_ctrlKeyTimeout",-1),tm(this,"_metaKeyTimeout",-1),tm(this,"_restoreToolId","select"),tm(this,"_pinchStart",1),tm(this,"_didPinch",!1),tm(this,"_selectedShapeIdsAtPointerDown",[]),tm(this,"_longPressTimeout",-1),tm(this,"capturedPointerId",null),tm(this,"performanceTracker"),tm(this,"performanceTrackerTimeout",-1),tm(this,"_pendingEventsForNextTick",[]),this._isShapeHiddenPredicate=g,this.options={...eR.a,...l},this.store=e,this.disposables.add(this.store.dispose.bind(this.store)),this.history=new e9.E({store:e,annotateError:e=>{this.annotateError(e,{origin:"history.batch",willCrashApp:!0}),this.crash(e)}}),this.snaps=new e6.f(this),this.disposables.add(this.timers.dispose),this._cameraOptions.set({...eO.B8,...a}),this.user=new ti.K(t??(0,eF.L)(),p??!1),this.getContainer=n,this.textMeasure=new te.R(this),this._tickManager=new tt.r(this);class d extends ts.m{static initial=h??""}this.root=new d(this),this.root.children={};let u=(0,eM.m)(i),c={},S={},f=new Map;for(let e of u){let t=new e(this);c[e.type]=t;let i=(0,eB.DR)(e.props??{});for(let t of(S[e.type]=i,i.keys()))if(f.has(t.id)){if(f.get(t.id)!==t)throw Error(`Multiple style props with id "${t.id}" in use. Style prop IDs must be unique.`)}else f.set(t.id,t)}this.shapeUtils=c,this.styleProps=S;let m=(0,eA.c)(s),y={};for(let e of m){let t=new e(this);y[e.type]=t}for(let e of(this.bindingUtils=y,[...r])){if((0,eb.nr)(this.root.children,e.id))throw Error(`Can't override tool with id "${e.id}"`);this.root.children[e.id]=new e(this,this.root)}this.scribbles=new e7.o(this);let P=(e,t)=>{let i=null,s=e.selectedShapeIds.filter(e=>!t.has(e));s.length!==e.selectedShapeIds.length&&(i||(i={...e}),i.selectedShapeIds=s);let r=e.erasingShapeIds.filter(e=>!t.has(e));r.length!==e.erasingShapeIds.length&&(i||(i={...e}),i.erasingShapeIds=r),e.hoveredShapeId&&t.has(e.hoveredShapeId)&&(i||(i={...e}),i.hoveredShapeId=null),e.editingShapeId&&t.has(e.editingShapeId)&&(i||(i={...e}),i.editingShapeId=null);let n=e.hintingShapeIds.filter(e=>!t.has(e));return n.length!==e.hintingShapeIds.length&&(i||(i={...e}),i.hintingShapeIds=n),e.focusedGroupId&&t.has(e.focusedGroupId)&&(i||(i={...e}),i.focusedGroupId=null),i};this.sideEffects=this.store.sideEffects;let I=new Map,C=new Set,w=new Set,_=new Set;if(this.disposables.add(this.sideEffects.registerOperationCompleteHandler(()=>{for(let e of(C.clear(),w)){w.delete(e);let t=this.getShape(e);if(!t)continue;let i=this.getShapeUtil(t),s=i.onChildrenChange?.(t);s?.length&&this.updateShapes(s)}if(_.size){let e=_;for(let t of(_=new Set,e)){let e=this.getBindingUtil(t);e.onOperationComplete?.()}}if(I.size){let e=I;for(let t of(I=new Map,e.values()))this.getBindingUtil(t.binding).onAfterDelete?.(t)}this.emit("update")})),this.disposables.add(this.sideEffects.register({shape:{afterChange:(e,t)=>{for(let i of this.getBindingsInvolvingShape(t))_.add(i.type),i.fromId===t.id&&this.getBindingUtil(i).onAfterChangeFromShape?.({binding:i,shapeBefore:e,shapeAfter:t}),i.toId===t.id&&this.getBindingUtil(i).onAfterChangeToShape?.({binding:i,shapeBefore:e,shapeAfter:t});if(e.parentId!==t.parentId){let e=e=>{let t=this.getShape(e);if(t)for(let e of this.getBindingsInvolvingShape(t))_.add(e.type),e.fromId===t.id&&this.getBindingUtil(e).onAfterChangeFromShape?.({binding:e,shapeBefore:t,shapeAfter:t}),e.toId===t.id&&this.getBindingUtil(e).onAfterChangeToShape?.({binding:e,shapeBefore:t,shapeAfter:t})};e(t.id),this.visitDescendants(t.id,e)}if(e.parentId!==t.parentId&&(0,eB.r5)(t.parentId)){let i=new Set([e.id]);for(let s of(this.visitDescendants(e.id,e=>{i.add(e)}),this.getPageStates())){if(s.pageId===t.parentId)continue;let e=P(s,i);e&&this.store.put([e])}}e.parentId&&(0,eB.YT)(e.parentId)&&w.add(e.parentId),t.parentId!==e.parentId&&(0,eB.YT)(t.parentId)&&w.add(t.parentId)},beforeDelete:e=>{if(C.has(e.id))return;e.parentId&&(0,eB.YT)(e.parentId)&&w.add(e.parentId),C.add(e.id);let t=[];for(let i of this.getBindingsInvolvingShape(e)){_.add(i.type),t.push(i.id);let s=this.getBindingUtil(i);i.fromId===e.id?(s.onBeforeIsolateToShape?.({binding:i,removedShape:e}),s.onBeforeDeleteFromShape?.({binding:i,shape:e})):(s.onBeforeIsolateFromShape?.({binding:i,removedShape:e}),s.onBeforeDeleteToShape?.({binding:i,shape:e}))}t.length&&this.deleteBindings(t);let i=new Set([e.id]),s=(0,eb.oA)(this.getPageStates().map(e=>P(e,i)));s.length&&this.store.put(s)}},binding:{beforeCreate:e=>this.getBindingUtil(e).onBeforeCreate?.({binding:e})||e,afterCreate:e=>{_.add(e.type),this.getBindingUtil(e).onAfterCreate?.({binding:e})},beforeChange:(e,t)=>this.getBindingUtil(t).onBeforeChange?.({bindingBefore:e,bindingAfter:t})||t,afterChange:(e,t)=>{_.add(t.type),this.getBindingUtil(t).onAfterChange?.({bindingBefore:e,bindingAfter:t})},beforeDelete:e=>{this.getBindingUtil(e).onBeforeDelete?.({binding:e})},afterDelete:e=>{this.getBindingUtil(e).onAfterDelete?.({binding:e}),_.add(e.type)}},page:{afterCreate:e=>{let t=eB.AN.createId(e.id),i=eB.iS.createId(e.id);this.store.has(t)||this.store.put([eB.AN.create({id:t})]),this.store.has(i)||this.store.put([eB.iS.create({id:i,pageId:e.id})])},afterDelete:(e,t)=>{if(this.getInstanceState()?.currentPageId===e.id){let i=this.getPages().find(t=>t.id!==e.id)?.id;i?this.store.put([{...this.getInstanceState(),currentPageId:i}]):"user"===t&&this.store.ensureStoreIsUsable()}let i=eB.AN.createId(e.id),s=eB.iS.createId(e.id);this.store.remove([i,s])}},instance:{afterChange:(e,t,i)=>{if(!this.store.has(t.currentPageId)){let s=this.store.has(e.currentPageId)?e.currentPageId:this.getPages()[0]?.id;s?this.store.update(t.id,e=>({...e,currentPageId:s})):"user"===i&&this.store.ensureStoreIsUsable()}}},instance_page_state:{afterChange:(e,t)=>{if(e?.selectedShapeIds!==t?.selectedShapeIds){let e=t.selectedShapeIds.filter(e=>{let i=this.getShape(e)?.parentId;for(;(0,eB.YT)(i);){if(t.selectedShapeIds.includes(i))return!1;i=this.getShape(i)?.parentId}return!0}),i=null;if(e.length>0){let t=this.findCommonAncestor((0,eb.oA)(e.map(e=>this.getShape(e))),e=>this.isShapeOfType(e,"group"));t&&(i=t)}else t?.focusedGroupId&&(i=t.focusedGroupId);(e.length!==t.selectedShapeIds.length||i!==t.focusedGroupId)&&this.store.put([{...t,selectedShapeIds:e,focusedGroupId:i??null}])}}}})),this._currentPageShapeIds=(0,e5.Q)(this.store,()=>this.getCurrentPageId()),this._parentIdsToChildIds=(0,e2.s)(this.store),this.disposables.add(this.store.listen(e=>{this.emit("change",e)})),this.disposables.add(this.history.dispose),this.run(()=>{this.store.ensureStoreIsUsable(),this._updateCurrentPageState({editingShapeId:null,hoveredShapeId:null,erasingShapeIds:[]})},{history:"ignore"}),h&&void 0===this.root.children[h])throw Error(`No state found for initialState "${h}".`);if(this.root.enter(void 0,"initial"),this.edgeScrollManager=new e3.O(this),this.focusManager=new e8.I(this,o),this.disposables.add(this.focusManager.dispose.bind(this.focusManager)),this.getInstanceState().followingUserId&&this.stopFollowingUser(),this.on("tick",this._flushEventsForTick),this.timers.requestAnimationFrame(()=>{this._tickManager.start()}),this.performanceTracker=new eb.aF,this.store.props.collaboration?.mode){let e=this.store.props.collaboration.mode;this.disposables.add((0,ex.Ym)("update collaboration mode",()=>{this.store.put([{...this.getInstanceState(),isReadonly:"readonly"===e.get()}])}))}}getIsShapeHiddenCache(){return this._isShapeHiddenPredicate?this.store.createComputedCache("isShapeHidden",e=>!!this.findShapeAncestor(e,e=>this.isShapeHidden(e))||(this._isShapeHiddenPredicate(e,this)??!1)):null}isShapeHidden(e){return!!this._isShapeHiddenPredicate&&!!this.getIsShapeHiddenCache().get("string"==typeof e?e:e.id)}dispose(){this.disposables.forEach(e=>e()),this.disposables.clear(),this.isDisposed=!0}getShapeUtil(e){let t="string"==typeof e?e:e.type,i=(0,eb.eg)(this.shapeUtils,t);return(0,eb.hu)(i,`No shape util found for type "${t}"`),i}getBindingUtil(e){let t="string"==typeof e?e:e.type,i=(0,eb.eg)(this.bindingUtils,t);return(0,eb.hu)(i,`No binding util found for type "${t}"`),i}undo(){return this._flushEventsForTick(0),this.complete(),this.history.undo(),this}getCanUndo(){return this.history.getNumUndos()>0}redo(){return this._flushEventsForTick(0),this.complete(),this.history.redo(),this}clearHistory(){return this.history.clear(),this}getCanRedo(){return this.history.getNumRedos()>0}mark(e){return"string"==typeof e?console.warn(`[tldraw] \`editor.history.mark("${e}")\` is deprecated. Please use \`const myMarkId = editor.markHistoryStoppingPoint()\` instead.`):console.warn("[tldraw] `editor.mark()` is deprecated. Use `editor.markHistoryStoppingPoint()` instead."),this.history._mark(e??(0,eb.EL)()),this}markHistoryStoppingPoint(e){let t=`[${e??"stop"}]_${(0,eb.EL)()}`;return this.history._mark(t),t}getMarkIdMatching(e){return this.history.getMarkIdMatching(e)}squashToMark(e){return this.history.squashToMark(e),this}bail(){return this.history.bail(),this}bailToMark(e){return this.history.bailToMark(e),this}run(e,t){let i=this._shouldIgnoreShapeLock;this._shouldIgnoreShapeLock=t?.ignoreShapeLock??i;try{this.history.batch(e,t)}finally{this._shouldIgnoreShapeLock=i}return this}batch(e,t){return this.run(e,t)}annotateError(e,{origin:t,willCrashApp:i,tags:s,extras:r}){let n=this.createErrorAnnotations(t,i);return(0,eb.lw)(e,{tags:{...n.tags,...s},extras:{...n.extras,...r}}),i&&this.store.markAsPossiblyCorrupted(),this}createErrorAnnotations(e,t){try{let i=this.getEditingShapeId();return{tags:{origin:e,willCrashApp:t},extras:{activeStateNode:this.root.getPath(),selectedShapes:this.getSelectedShapes(),editingShape:i?this.getShape(i):void 0,inputs:this.inputs}}}catch{return{tags:{origin:e,willCrashApp:t},extras:{}}}}getCrashingError(){return this._crashingError}crash(e){return this._crashingError=e,this.store.markAsPossiblyCorrupted(),this.emit("crash",{error:e}),this}getPath(){return this.root.getPath().split("root.")[1]}isIn(e){let t=e.split(".").reverse(),i=this.root;for(;t.length>0;){let e=t.pop();if(!e)return!0;let s=i.getCurrent();if(s?.id===e){if(0===t.length)return!0;i=s;continue}break}return!1}isInAny(...e){return e.some(e=>this.isIn(e))}setCurrentTool(e,t={}){return this.root.transition(e,t),this}getCurrentTool(){return this.root.getCurrent()}getCurrentToolId(){let e=this.getCurrentTool();return e?e.getCurrentToolIdMask()??e.id:""}getStateDescendant(e){let t=e.split(".").reverse(),i=this.root;for(;t.length>0;){let e=t.pop();if(!e)break;let s=i.children?.[e];if(!s)return;i=s}return i}getDocumentSettings(){return this.store.get(eB.G4)}updateDocumentSettings(e){return this.run(()=>{this.store.put([{...this.getDocumentSettings(),...e}])},{history:"ignore"}),this}getInstanceState(){return this.store.get(eB.PQ)}updateInstanceState(e,t){return this._updateInstanceState(e,{history:"ignore",...t}),void 0!==e.isChangingStyle&&(clearTimeout(this._isChangingStyleTimeout),!0===e.isChangingStyle&&(this._isChangingStyleTimeout=this.timers.setTimeout(()=>{this._updateInstanceState({isChangingStyle:!1},{history:"ignore"})},2e3))),this}_updateInstanceState(e,t){this.run(()=>{this.store.put([{...this.getInstanceState(),...e}])},t)}getOpenMenus(){return this.menus.getOpenMenus()}addOpenMenu(e){return this.menus.addOpenMenu(e),this}deleteOpenMenu(e){return this.menus.deleteOpenMenu(e),this}clearOpenMenus(){return this.menus.clearOpenMenus(),this}getIsMenuOpen(){return this.menus.hasAnyOpenMenus()}setCursor(e){return this.updateInstanceState({cursor:{...this.getInstanceState().cursor,...e}}),this}getPageStates(){return this._getPageStatesQuery().get()}_getPageStatesQuery(){return this.store.query.records("instance_page_state")}getCurrentPageState(){return this.store.get(this._getCurrentPageStateId())}_getCurrentPageStateId(){return eB.iS.createId(this.getCurrentPageId())}updateCurrentPageState(e){return this._updateCurrentPageState(e),this}_updateCurrentPageState(e){this.store.update(e.id??this.getCurrentPageState().id,t=>({...t,...e}))}getSelectedShapeIds(){return this.getCurrentPageState().selectedShapeIds}getSelectedShapes(){let{selectedShapeIds:e}=this.getCurrentPageState();return(0,eb.oA)(e.map(e=>this.store.get(e)))}setSelectedShapes(e){return this.run(()=>{let t=e.map(e=>"string"==typeof e?e:e.id),{selectedShapeIds:i}=this.getCurrentPageState(),s=new Set(i);if(t.length===s.size&&t.every(e=>s.has(e)))return null;this.store.put([{...this.getCurrentPageState(),selectedShapeIds:t}])},{history:"record-preserveRedoStack"})}isAncestorSelected(e){let t="string"==typeof e?e:e?.id??null,i=this.getShape(t);if(!i)return!1;let s=this.getSelectedShapeIds();return!!this.findShapeAncestor(i,e=>s.includes(e.id))}select(...e){let t="string"==typeof e[0]?e:e.map(e=>e.id);return this.setSelectedShapes(t),this}deselect(...e){let t="string"==typeof e[0]?e:e.map(e=>e.id),i=this.getSelectedShapeIds();return i.length>0&&t.length>0&&this.setSelectedShapes(i.filter(e=>!t.includes(e))),this}selectAll(){let e=this.getSortedChildIdsForParent(this.getCurrentPageId());return e.length<=0||this.setSelectedShapes(this._getUnlockedShapeIds(e)),this}selectNone(){return this.getSelectedShapeIds().length>0&&this.setSelectedShapes([]),this}getOnlySelectedShapeId(){return this.getOnlySelectedShape()?.id??null}getOnlySelectedShape(){let e=this.getSelectedShapes();return 1===e.length?e[0]:null}getShapesPageBounds(e){let t=(0,eb.oA)(e.map(e=>this.getShapePageBounds(e)));return 0===t.length?null:ez.xu.Common(t)}getSelectionPageBounds(){return this.getShapesPageBounds(this.getSelectedShapeIds())}getShapesSharedRotation(e){let t=!1,i=0;for(let s=0,r=e.length;s<r;s++){let r=this.getShapePageTransform(e[s]);if(r){if(t){if(r.rotation()!==i)return 0}else t=!0,i=r.rotation()}}return i}getSelectionRotation(){return this.getShapesSharedRotation(this.getSelectedShapeIds())}getShapesRotatedPageBounds(e){if(0===e.length)return;let t=this.getShapesSharedRotation(e);if(0===t)return this.getShapesPageBounds(e)??void 0;if(1===e.length){let t=this.getShapeGeometry(e[0]).bounds.clone(),i=this.getShapePageTransform(e[0]);return t.point=i.applyToPoint(t.point),t}let i=ez.xu.FromPoints(e.flatMap(e=>{let t=this.getShapePageTransform(e);return t?t.applyToPoints(this.getShapeGeometry(e).bounds.corners):[]}).map(e=>e.rot(-t)));return i.point=i.point.rot(t),i}getSelectionRotatedPageBounds(){return this.getShapesRotatedPageBounds(this.getSelectedShapeIds())}getSelectionRotatedScreenBounds(){let e=this.getSelectionRotatedPageBounds();if(!e)return;let{x:t,y:i}=this.pageToScreen(e.point),s=this.getZoomLevel();return new ez.xu(t,i,e.width*s,e.height*s)}getFocusedGroupId(){return this.getCurrentPageState().focusedGroupId??this.getCurrentPageId()}getFocusedGroup(){let e=this.getFocusedGroupId();return e?this.getShape(e):void 0}setFocusedGroup(e){let t="string"==typeof e?e:e?.id??null;if(null!==t){let e=this.getShape(t);if(!e)throw Error(`Editor.setFocusedGroup: Shape with id ${t} does not exist`);if(!this.isShapeOfType(e,"group"))throw Error(`Editor.setFocusedGroup: Cannot set focused group to shape of type ${e.type}`)}return t===this.getFocusedGroupId()?this:this.run(()=>{this.store.update(this.getCurrentPageState().id,e=>({...e,focusedGroupId:t}))},{history:"record-preserveRedoStack"})}popFocusedGroupId(){let e=this.getFocusedGroup();if(e){let t=this.findShapeAncestor(e,e=>this.isShapeOfType(e,"group"));this.setFocusedGroup(t?.id??null),this.select(e.id)}else this.setFocusedGroup(null),this.selectNone();return this}getEditingShapeId(){return this.getCurrentPageState().editingShapeId}getEditingShape(){let e=this.getEditingShapeId();return e?this.getShape(e):void 0}setEditingShape(e){let t="string"==typeof e?e:e?.id??null;if(t!==this.getEditingShapeId()){if(t){let e=this.getShape(t);if(e&&this.getShapeUtil(e).canEdit(e))return this.run(()=>{this._updateCurrentPageState({editingShapeId:t})},{history:"ignore"}),this}this.run(()=>{this._updateCurrentPageState({editingShapeId:null})},{history:"ignore"})}return this}getHoveredShapeId(){return this.getCurrentPageState().hoveredShapeId}getHoveredShape(){let e=this.getHoveredShapeId();return e?this.getShape(e):void 0}setHoveredShape(e){let t="string"==typeof e?e:e?.id??null;return t===this.getHoveredShapeId()||this.run(()=>{this.updateCurrentPageState({hoveredShapeId:t})},{history:"ignore"}),this}getHintingShapeIds(){return this.getCurrentPageState().hintingShapeIds}getHintingShape(){let e=this.getHintingShapeIds();return(0,eb.oA)(e.map(e=>this.getShape(e)))}setHintingShapes(e){let t="string"==typeof e[0]?e:e.map(e=>e.id);return this.run(()=>{this._updateCurrentPageState({hintingShapeIds:(0,eb.D8)(t)})},{history:"ignore"}),this}getErasingShapeIds(){return this.getCurrentPageState().erasingShapeIds}getErasingShapes(){let e=this.getErasingShapeIds();return(0,eb.oA)(e.map(e=>this.getShape(e)))}setErasingShapes(e){let t="string"==typeof e[0]?e:e.map(e=>e.id);t.sort();let i=this.getErasingShapeIds();return this.run(()=>{if(t.length===i.length){for(let e=0;e<t.length;e++)if(t[e]!==i[e]){this._updateCurrentPageState({erasingShapeIds:t});break}}else this._updateCurrentPageState({erasingShapeIds:t})},{history:"ignore"}),this}getCroppingShapeId(){return this.getCurrentPageState().croppingShapeId}setCroppingShape(e){let t="string"==typeof e?e:e?.id??null;return t!==this.getCroppingShapeId()&&this.run(()=>{if(t){let e=this.getShape(t),i=this.getShapeUtil(e);e&&i.canCrop(e)&&this.updateCurrentPageState({croppingShapeId:t})}else this.updateCurrentPageState({croppingShapeId:null})},{history:"ignore"}),this}_unsafe_getCameraId(){return eB.AN.createId(this.getCurrentPageId())}getCamera(){let e=this.store.get(this._unsafe_getCameraId());if(this._isLockedOnFollowingUser.get()){let t=this.getCameraForFollowing();if(t)return{...e,...t}}return e}getViewportPageBoundsForFollowing(){let e=this.getInstanceState().followingUserId;if(!e)return null;let t=this.getCollaborators().find(t=>t.userId===e);if(!t)return null;let{w:i,h:s}=t.screenBounds,{x:r,y:n,z:a}=t.camera,h=new ez.xu(-r,-n,i/a,s/a),o=this.getViewportScreenBounds().clone(),p=o.width/o.height;return o.width=h.width,o.height=o.width/p,o.height<h.height&&(o.height=h.height,o.width=o.height*p),o.center=h.center,o}getCameraForFollowing(){let e=this.getViewportPageBoundsForFollowing();return e?{x:-e.x,y:-e.y,z:this.getViewportScreenBounds().w/e.width}:null}getZoomLevel(){return this.getCamera().z}getInitialZoom(){let e=this.getCameraOptions();if(!e.constraints||"default"===e.constraints.initialZoom)return 1;let{zx:t,zy:i}=tb(this,e);switch(e.constraints.initialZoom){case"fit-min":return Math.max(t,i);case"fit-max":return Math.min(t,i);case"fit-x":return t;case"fit-y":return i;case"fit-min-100":return Math.min(1,Math.max(t,i));case"fit-max-100":return Math.min(1,Math.min(t,i));case"fit-x-100":return Math.min(1,t);case"fit-y-100":return Math.min(1,i);default:throw(0,eb.iP)(e.constraints.initialZoom)}}getBaseZoom(){let e=this.getCameraOptions();if(!e.constraints||"default"===e.constraints.baseZoom)return 1;let{zx:t,zy:i}=tb(this,e);switch(e.constraints.baseZoom){case"fit-min":return Math.max(t,i);case"fit-max":return Math.min(t,i);case"fit-x":return t;case"fit-y":return i;case"fit-min-100":return Math.min(1,Math.max(t,i));case"fit-max-100":return Math.min(1,Math.min(t,i));case"fit-x-100":return Math.min(1,t);case"fit-y-100":return Math.min(1,i);default:throw(0,eb.iP)(e.constraints.baseZoom)}}getCameraOptions(){return this._cameraOptions.get()}setCameraOptions(e){let t=(0,eb.v4)({...this._cameraOptions.__unsafe__getWithoutCapture(),...e});return t.zoomSteps?.length<1&&(t.zoomSteps=[1]),this._cameraOptions.set(t),this.setCamera(this.getCamera()),this}getConstrainedCamera(e,t){let i=this.getCamera(),{x:s,y:r,z:n=i.z}=e;if(!t?.force){let e=this.getCameraOptions(),a=e.zoomSteps[0],h=(0,eb.Z$)(e.zoomSteps),o=this.getViewportScreenBounds();if(e.constraints){let{constraints:p}=e,l=Math.min(p.padding.y,o.w/2),g=Math.min(p.padding.x,o.h/2),d=ez.xu.From(e.constraints.bounds),u=(o.w-2*g)/d.w,c=(o.h-2*l)/d.h,S=this.getBaseZoom(),f=h*S,m=a*S;if(t?.reset&&(n=this.getInitialZoom()),n<m||n>f){let{x:e,y:t,z:a}=i,h=-e+o.w/a/2,p=-t+o.h/a/2;n=(0,eY.uZ)(n,m,f);let l=-e+o.w/n/2,g=-t+o.h/n/2;s=e+l-h,r=t+g-p}let y=g/n-d.x,P=l/n-d.y,I=(o.w-2*g)/n-d.w,C=(o.h-2*l)/n-d.h,w=y+I*p.origin.x,_=P+C*p.origin.y,T="string"==typeof p.behavior?p.behavior:p.behavior.x,B="string"==typeof p.behavior?p.behavior:p.behavior.y;if(t?.reset)s=w,r=_;else{switch(T){case"fixed":s=w;break;case"contain":s=n<u?w:(0,eY.uZ)(s,y+I,y);break;case"inside":s=n<u?(0,eY.uZ)(s,y,(o.w-g)/n-d.w):(0,eY.uZ)(s,y+I,y);break;case"outside":s=(0,eY.uZ)(s,g/n-d.w,(o.w-g)/n);break;case"free":break;default:throw(0,eb.iP)(T)}switch(B){case"fixed":r=_;break;case"contain":r=n<c?_:(0,eY.uZ)(r,P+C,P);break;case"inside":r=n<c?(0,eY.uZ)(r,P,(o.h-l)/n-d.h):(0,eY.uZ)(r,P+C,P);break;case"outside":r=(0,eY.uZ)(r,l/n-d.h,(o.h-l)/n);break;case"free":break;default:throw(0,eb.iP)(B)}}}else if(n>h||n<a){let{x:e,y:t,z:p}=i;n=(0,eY.uZ)(n,a,h),s=e+(-e+o.w/n/2)-(-e+o.w/p/2),r=t+(-t+o.h/n/2)-(-t+o.h/p/2)}}return{x:s,y:r,z:n}}_setCamera(e,t){let i=this.getCamera(),{x:s,y:r,z:n}=this.getConstrainedCamera(e,t);return i.x===s&&i.y===r&&i.z===n||(0,ex.ay)(()=>{let e={...i,x:s,y:r,z:n};this.run(()=>{this.store.put([e])},{history:"ignore"});let{currentScreenPoint:a,currentPagePoint:h}=this.inputs,{screenBounds:o}=this.store.unsafeGetWithoutCapture(eB.PQ);if(a.x/n-s!==h.x||a.y/n-r!==h.y){let e={type:"pointer",target:"canvas",name:"pointer_move",point:eV.B.AddXY(a,o.x,o.y),pointerId:eO.CK.CAMERA_MOVE,ctrlKey:this.inputs.ctrlKey,altKey:this.inputs.altKey,shiftKey:this.inputs.shiftKey,metaKey:this.inputs.metaKey,accelKey:(0,e$.q)(this.inputs),button:0,isPen:this.getInstanceState().isPenMode??!1};t?.immediate?this._flushEventForTick(e):this.dispatch(e)}this._tickCameraState()}),this}setCamera(e,t){let{isLocked:i}=this._cameraOptions.__unsafe__getWithoutCapture();if(i&&!t?.force)return this;this.stopCameraAnimation(),this.getInstanceState().followingUserId&&this.stopFollowingUser();let s=eV.B.Cast(e);Number.isFinite(s.x)||(s.x=0),Number.isFinite(s.y)||(s.y=0),void 0!==s.z&&Number.isFinite(s.z)||(e.z=this.getZoomLevel());let r=this.getConstrainedCamera(s,t);if(t?.animation){let{width:e,height:i}=this.getViewportScreenBounds();this._animateToViewport(new ez.xu(-r.x,-r.y,e/r.z,i/r.z),t)}else this._setCamera(r,{...t,force:!0});return this}centerOnPoint(e,t){let{isLocked:i}=this.getCameraOptions();if(i&&!t?.force)return this;let{width:s,height:r}=this.getViewportPageBounds();return this.setCamera(new eV.B(-(e.x-s/2),-(e.y-r/2),this.getCamera().z),t),this}zoomToFit(e){let t=[...this.getCurrentPageShapeIds()];if(t.length<=0)return this;let i=ez.xu.Common((0,eb.oA)(t.map(e=>this.getShapePageBounds(e))));return this.zoomToBounds(i,e),this}resetZoom(e=this.getViewportScreenCenter(),t){let{isLocked:i,constraints:s}=this.getCameraOptions();if(i&&!t?.force)return this;let{x:r,y:n,z:a}=this.getCamera(),{x:h,y:o}=e,p=1;if(s){let e=this.getInitialZoom();a!==e&&(p=e)}return this.setCamera(new eV.B(r+(h/p-h)-(h/a-h),n+(o/p-o)-(o/a-o),p),t),this}zoomIn(e=this.getViewportScreenCenter(),t){let{isLocked:i}=this.getCameraOptions();if(i&&!t?.force)return this;let{x:s,y:r,z:n}=this.getCamera(),{zoomSteps:a}=this.getCameraOptions();if(null!==a&&a.length>1){let i=this.getBaseZoom(),h=(0,eb.Z$)(a)*i;for(let e=1;e<a.length;e++){let t=a[e-1]*i,s=a[e]*i;if(!(s-n<=(s-t)/2)){h=s;break}}this.setCamera(new eV.B(s+(e.x/h-e.x)-(e.x/n-e.x),r+(e.y/h-e.y)-(e.y/n-e.y),h),t)}return this}zoomOut(e=this.getViewportScreenCenter(),t){let{isLocked:i}=this.getCameraOptions();if(i&&!t?.force)return this;let{zoomSteps:s}=this.getCameraOptions();if(null!==s&&s.length>1){let i=this.getBaseZoom(),{x:r,y:n,z:a}=this.getCamera(),h=s[0]*i;for(let e=s.length-1;e>0;e--){let t=s[e-1]*i,r=s[e]*i;if(!(r-a>=(r-t)/2)){h=t;break}}this.setCamera(new eV.B(r+(e.x/h-e.x)-(e.x/a-e.x),n+(e.y/h-e.y)-(e.y/a-e.y),h),t)}return this}zoomToSelection(e){let{isLocked:t}=this.getCameraOptions();if(t&&!e?.force)return this;let i=this.getSelectionPageBounds();return i&&this.zoomToBounds(i,{targetZoom:Math.max(1,this.getZoomLevel()),...e}),this}zoomToBounds(e,t){let i=this._cameraOptions.__unsafe__getWithoutCapture();if(i.isLocked&&!t?.force)return this;let s=this.getViewportScreenBounds(),r=t?.inset??Math.min(eO.TP,.28*s.width),n=this.getBaseZoom(),a=i.zoomSteps[0],h=(0,eb.Z$)(i.zoomSteps),o=(0,eY.uZ)(Math.min((s.width-r)/e.w,(s.height-r)/e.h),a*n,h*n);return t?.targetZoom!==void 0&&(o=Math.min(t.targetZoom,o)),this.setCamera(new eV.B(-e.x+(s.width-e.w*o)/2/o,-e.y+(s.height-e.h*o)/2/o,o),t),this}stopCameraAnimation(){return this.emit("stop-camera-animation"),this}_animateViewport(e){if(!this._viewportAnimation)return;this._viewportAnimation.elapsed+=e;let{elapsed:t,easing:i,duration:s,start:r,end:n}=this._viewportAnimation;if(t>s){this.off("tick",this._animateViewport),this._viewportAnimation=null,this._setCamera(new eV.B(-n.x,-n.y,this.getViewportScreenBounds().width/n.width));return}let a=i(1-(s-t)/s),h=r.minX+(n.minX-r.minX)*a,o=r.minY+(n.minY-r.minY)*a,p=r.maxX+(n.maxX-r.maxX)*a;this._setCamera(new eV.B(-h,-o,this.getViewportScreenBounds().width/(p-h)),{force:!0})}_animateToViewport(e,t={animation:eO.Xy}){let{animation:i,...s}=t;if(!i)return;let{duration:r=0,easing:n=eH.L.easeInOutCubic}=i,a=this.user.getAnimationSpeed(),h=this.getViewportPageBounds();return(this.stopCameraAnimation(),this.getInstanceState().followingUserId&&this.stopFollowingUser(),0===r||0===a)?this._setCamera(new eV.B(-e.x,-e.y,this.getViewportScreenBounds().width/e.width),{...s}):(this._viewportAnimation={elapsed:0,duration:r/a,easing:n,start:h.clone(),end:e.clone()},this.once("stop-camera-animation",()=>{this.off("tick",this._animateViewport),this._viewportAnimation=null}),this.on("tick",this._animateViewport),this)}slideCamera(e={}){let{isLocked:t}=this.getCameraOptions();if(t&&!e?.force||0===this.user.getAnimationSpeed())return this;this.stopCameraAnimation();let{speed:i,friction:s=this.options.cameraSlideFriction,direction:r,speedThreshold:n=.01}=e,a=Math.min(i,1),h=()=>{this.off("tick",o),this.off("stop-camera-animation",h)};this.once("stop-camera-animation",h);let o=e=>{let{x:t,y:i,z:o}=this.getCamera(),p=eV.B.Mul(r,a*e/o);(a*=1-s)<n?h():this._setCamera(new eV.B(t+p.x,i+p.y,o))};return this.on("tick",o),this}zoomToUser(e,t={animation:{duration:500}}){let i=this.getCollaborators().find(t=>t.userId===e);return i&&this.run(()=>{null!==this.getInstanceState().followingUserId&&this.stopFollowingUser();let s=i.currentPageId===this.getCurrentPageId();s||this.setCurrentPage(i.currentPageId),t&&t.animation&&!s&&(t.animation=void 0),this.centerOnPoint(i.cursor,t);let{highlightedUserIds:r}=this.getInstanceState();this.updateInstanceState({highlightedUserIds:[...r,e]}),this.timers.setTimeout(()=>{let t=[...this.getInstanceState().highlightedUserIds],i=t.indexOf(e);i<0||(t.splice(i,1),this.updateInstanceState({highlightedUserIds:t}))},this.options.collaboratorIdleTimeoutMs)}),this}updateViewportScreenBounds(e,t=!1){if(e instanceof HTMLElement){let t=e.getBoundingClientRect();e=new ez.xu(t.left||t.x,t.top||t.y,Math.max(t.width,1),Math.max(t.height,1))}else e.width=Math.max(e.width,1),e.height=Math.max(e.height,1);let i=[0!==e.minY,!(0,eY.C2)(document.body.scrollWidth,e.maxX,1),!(0,eY.C2)(document.body.scrollHeight,e.maxY,1),0!==e.minX],{_willSetInitialBounds:s}=this;this._willSetInitialBounds=!1;let{screenBounds:r,insets:n}=this.getInstanceState();if(e.equals(r)&&i.every((e,t)=>e===n[t]))return this;if(s)this.updateInstanceState({screenBounds:e.toJson(),insets:i}),this.setCamera(this.getCamera());else if(t&&!this.getInstanceState().followingUserId){let t=this.getViewportPageBounds().center;this.updateInstanceState({screenBounds:e.toJson(),insets:i}),this.centerOnPoint(t)}else this.updateInstanceState({screenBounds:e.toJson(),insets:i}),this._setCamera(eV.B.From({...this.getCamera()}));return this._tickCameraState(),this}getViewportScreenBounds(){let{x:e,y:t,w:i,h:s}=this.getInstanceState().screenBounds;return new ez.xu(e,t,i,s)}getViewportScreenCenter(){let e=this.getViewportScreenBounds();return new eV.B(e.midX-e.minX,e.midY-e.minY)}getViewportPageBounds(){let{w:e,h:t}=this.getViewportScreenBounds(),{x:i,y:s,z:r}=this.getCamera();return new ez.xu(-i,-s,e/r,t/r)}screenToPage(e){let{screenBounds:t}=this.store.unsafeGetWithoutCapture(eB.PQ),{x:i,y:s,z:r=1}=this.getCamera();return new eV.B((e.x-t.x)/r-i,(e.y-t.y)/r-s,e.z??.5)}pageToScreen(e){let{screenBounds:t}=this.store.unsafeGetWithoutCapture(eB.PQ),{x:i,y:s,z:r=1}=this.getCamera();return new eV.B((e.x+i)*r+t.x,(e.y+s)*r+t.y,e.z??.5)}pageToViewport(e){let{x:t,y:i,z:s=1}=this.getCamera();return new eV.B((e.x+t)*s,(e.y+i)*s,e.z??.5)}_getCollaboratorsQuery(){return this.store.query.records("instance_presence",()=>({userId:{neq:this.user.getId()}}))}getCollaborators(){let e=this._getCollaboratorsQuery().get();return e.length?[...new Set(e.map(e=>e.userId))].sort().map(t=>e.filter(e=>e.userId===t).sort((e,t)=>t.lastActivityTimestamp-e.lastActivityTimestamp)[0]):ex.LZ}getCollaboratorsOnCurrentPage(){let e=this.getCurrentPageId();return this.getCollaborators().filter(t=>t.currentPageId===e)}startFollowingUser(e){this.stopFollowingUser();let t=this._getCollaboratorsQuery().get().filter(t=>t.userId===e);if(!t.length)return console.warn("User not found"),this;let i=this.user.getId();if(i||console.warn("You should set the userId for the current instance before following a user"),t.some(e=>e.followingUserId===i))return this;let s=(0,ex.Fl)("latestLeaderPresence",()=>this.getCollaborators().find(t=>t.userId===e));return(0,ex.ay)(()=>{this.updateInstanceState({followingUserId:e},{history:"ignore"});let t=(0,ex.Ym)("update current page",()=>{let e=s.get();if(!e){this.stopFollowingUser();return}e.currentPageId!==this.getCurrentPageId()&&this.getPage(e.currentPageId)&&this.run(()=>{this.store.put([{...this.getInstanceState(),currentPageId:e.currentPageId}]),this._isLockedOnFollowingUser.set(!0)},{history:"ignore"})}),i=()=>{t(),this._isLockedOnFollowingUser.set(!1),this.off("frame",r),this.off("stop-following",i)},r=()=>{if(!s.get()){this.stopFollowingUser();return}if(this._isLockedOnFollowingUser.get())return;let e=this.user.getAnimationSpeed();if(0===e){this._isLockedOnFollowingUser.set(!0);return}let t=this.getViewportPageBoundsForFollowing();if(!t){this.stopFollowingUser();return}let i=this.getViewportPageBounds(),r=Math.abs(t.minX-i.minX)+Math.abs(t.maxX-i.maxX),n=Math.abs(t.minY-i.minY)+Math.abs(t.maxY-i.maxY);if(r<this.options.followChaseViewportSnap&&n<this.options.followChaseViewportSnap){this._isLockedOnFollowingUser.set(!0);return}let a=(0,eY.uZ)(.5*e,.1,.8),h=new ez.xu((0,eb.t7)(i.minX,t.minX,a),(0,eb.t7)(i.minY,t.minY,a),(0,eb.t7)(i.width,t.width,a),(0,eb.t7)(i.height,t.height,a)),o=new eV.B(-h.x,-h.y,this.getViewportScreenBounds().width/h.width);this.stopCameraAnimation(),this._setCamera(o)};this.once("stop-following",i),this.addListener("frame",r),r()}),this}stopFollowingUser(){return this.run(()=>{this.store.put([this.getCamera()]),this._isLockedOnFollowingUser.set(!1),this.updateInstanceState({followingUserId:null}),this.emit("stop-following")},{history:"ignore"}),this}getUnorderedRenderingShapes(e){let t=[],i=2*this.options.maxShapesPerPage,s=this.options.maxShapesPerPage,r=this.getErasingShapeIds(),n=(a,h,o)=>{let p=this.getShape(a);if(!p||this.isShapeHidden(p))return;h*=p.opacity;let l=!1,g=this.getShapeUtil(p);e&&(l=!o&&r.includes(a))&&(h*=.32),t.push({id:a,shape:p,util:g,index:i,backgroundIndex:s,opacity:h}),i+=1,s+=1;let d=this.getSortedChildIdsForParent(a);if(!d.length)return;let u=null;for(let e of(g.providesBackgroundForChildren(p)&&(u=s,s=i,i+=this.options.maxShapesPerPage),d))n(e,h,o||l);null!==u&&(s=u)};for(let t of e?[this.getCurrentPage()]:this.getPages())for(let e of this.getSortedChildIdsForParent(t.id))n(e,1,!1);return t}_decayCameraStateTimeout(e){this._cameraStateTimeoutRemaining-=e,this._cameraStateTimeoutRemaining>0||(this.off("tick",this._decayCameraStateTimeout),this._cameraState.set("idle"))}_tickCameraState(){this._cameraStateTimeoutRemaining=this.options.cameraMovingTimeoutMs,"idle"===this._cameraState.__unsafe__getWithoutCapture()&&(this._cameraState.set("moving"),this.on("tick",this._decayCameraStateTimeout))}getCameraState(){return this._cameraState.get()}getRenderingShapes(){return this.getUnorderedRenderingShapes(!0).sort(eb.uv)}_getAllPagesQuery(){return this.store.query.records("page")}getPages(){return this._getAllPagesQuery().get().sort(eb.hl)}getCurrentPage(){return this.getPage(this.getCurrentPageId())}getCurrentPageId(){return this.getInstanceState().currentPageId}getPage(e){return this.store.get("string"==typeof e?e:e.id)}getCurrentPageShapeIds(){return this._currentPageShapeIds.get()}getCurrentPageShapeIdsSorted(){return Array.from(this.getCurrentPageShapeIds()).sort()}getPageShapeIds(e){let t="string"==typeof e?e:e.id,i=this.store.query.exec("shape",{parentId:{eq:t}});return this.getShapeAndDescendantIds(i.map(e=>e.id))}setCurrentPage(e){let t="string"==typeof e?e:e.id;return this.store.has(t)?(this.stopFollowingUser(),this.complete(),this.run(()=>{this.store.put([{...this.getInstanceState(),currentPageId:t}]),this.setCamera(this.getCamera())},{history:"record-preserveRedoStack"})):(console.error("Tried to set the current page id to a page that doesn't exist."),this)}updatePage(e){return this.getIsReadonly()||!this.getPage(e.id)?this:this.run(()=>this.store.update(e.id,t=>({...t,...e})))}createPage(e){return this.run(()=>{if(this.getIsReadonly()||this.getPages().length>=this.options.maxPages)return;let t=this.getPages(),i=(0,eQ.u)(e.name??"Page 1",t.map(e=>e.name)),s=e.index;(!s||t.some(e=>e.index===s))&&(s=(0,eb._L)(t[t.length-1].index));let r=eB.ez.create({meta:{},...e,name:i,index:s});this.store.put([r])}),this}deletePage(e){let t="string"==typeof e?e:e.id;return this.run(()=>{if(this.getIsReadonly())return;let e=this.getPages();if(1===e.length)return;let i=this.getPage(t);if(i){if(t===this.getCurrentPageId()){let i=e.findIndex(e=>e.id===t),s=e[i-1]??e[i+1];this.setCurrentPage(s.id)}this.store.remove([i.id])}}),this}duplicatePage(e,t=eB.ez.createId()){if(this.getPages().length>=this.options.maxPages)return this;let i="string"==typeof e?e:e.id,s=this.getPage(i);if(!s)return this;let r={...this.getCamera()},n=this.getContentFromCurrentPage(this.getSortedChildIdsForParent(s.id));return this.run(()=>{let e=this.getPages(),i=(0,eb.eI)(s.index,e[e.indexOf(s)+1]?.index);if(this.createPage({name:s.name+" Copy",id:t,index:i}),this.setCurrentPage(t),this.setCamera(r),n)return this.putContentOntoCurrentPage(n)}),this}renamePage(e,t){let i="string"==typeof e?e:e.id;return this.getIsReadonly()||this.updatePage({id:i,name:t}),this}_getAllAssetsQuery(){return this.store.query.records("asset")}getAssets(){return this._getAllAssetsQuery().get()}createAssets(e){return this.getIsReadonly()||e.length<=0||this.run(()=>this.store.put(e),{history:"ignore"}),this}updateAssets(e){return this.getIsReadonly()||e.length<=0||this.run(()=>{this.store.put(e.map(e=>({...this.store.get(e.id),...e})))},{history:"ignore"}),this}deleteAssets(e){if(this.getIsReadonly())return this;let t="string"==typeof e[0]?e:e.map(e=>e.id);return t.length<=0||this.run(()=>this.store.remove(t),{history:"ignore"}),this}getAsset(e){return this.store.get("string"==typeof e?e:e.id)}async resolveAssetUrl(e,t){if(!e)return null;let i=this.getAsset(e);if(!i)return null;let{screenScale:s=1,shouldResolveToOriginal:r=!1}=t,n=Math.max(.125,Math.pow(2,Math.ceil(Math.log2(s)))),a="connection"in navigator?navigator.connection.effectiveType:null,h=this.getInstanceState().devicePixelRatio;return await this.store.props.assets.resolve(i,{screenScale:s||1,steppedScreenScale:n,dpr:h,networkEffectiveType:a,shouldResolveToOriginal:r})}async uploadAsset(e,t){return await this.store.props.assets.upload(e,t)}_getShapeGeometryCache(){return this.store.createComputedCache("bounds",e=>this.getShapeUtil(e).getGeometry(e),(e,t)=>e.props===t.props)}getShapeGeometry(e){return this._getShapeGeometryCache().get("string"==typeof e?e:e.id)}_getShapeHandlesCache(){return this.store.createComputedCache("handles",e=>this.getShapeUtil(e).getHandles?.(e))}getShapeHandles(e){return this._getShapeHandlesCache().get("string"==typeof e?e:e.id)}getShapeLocalTransform(e){let t="string"==typeof e?e:e.id,i=this.getShape(t);if(!i)throw Error("Editor.getTransform: shape not found");return eD._.Identity().translate(i.x,i.y).rotate(i.rotation)}_getShapePageTransformCache(){return this.store.createComputedCache("pageTransformCache",e=>{if((0,eB.r5)(e.parentId))return this.getShapeLocalTransform(e);let t=this._getShapePageTransformCache().get(e.parentId)??eD._.Identity();return eD._.Compose(t,this.getShapeLocalTransform(e))})}getShapeParentTransform(e){let t="string"==typeof e?e:e.id,i=this.getShape(t);return!i||(0,eB.r5)(i.parentId)?eD._.Identity():this._getShapePageTransformCache().get(i.parentId)??eD._.Identity()}getShapePageTransform(e){let t="string"==typeof e?e:e.id;return this._getShapePageTransformCache().get(t)??eD._.Identity()}_getShapePageBoundsCache(){return this.store.createComputedCache("pageBoundsCache",e=>{let t=this._getShapePageTransformCache().get(e.id);return t?ez.xu.FromPoints(eD._.applyToPoints(t,this.getShapeGeometry(e).vertices)):new ez.xu})}getShapePageBounds(e){return this._getShapePageBoundsCache().get("string"==typeof e?e:e.id)}_getShapeClipPathCache(){return this.store.createComputedCache("clipPathCache",e=>{let t=this._getShapeMaskCache().get(e.id);if(!t)return;if(0===t.length)return"polygon(0px 0px, 0px 0px, 0px 0px)";let i=this._getShapePageTransformCache().get(e.id);if(!i)return;let s=eD._.applyToPoints(eD._.Inverse(i),t);return`polygon(${s.map(e=>`${e.x}px ${e.y}px`).join(",")})`})}getShapeClipPath(e){return this._getShapeClipPathCache().get("string"==typeof e?e:e.id)}_getShapeMaskCache(){return this.store.createComputedCache("pageMaskCache",e=>{if((0,eB.r5)(e.parentId))return;let t=this.getShapeAncestors(e.id).filter(e=>this.isShapeOfType(e,"frame"));if(0!==t.length)return t.map(e=>this._getShapePageTransformCache().get(e.id).applyToPoints(this.getShapeGeometry(e).vertices)).reduce((e,t)=>{if(!(t&&e))return;let i=(0,eZ.tY)(e,t);return i?i.map(eV.B.Cast):[]})})}getShapeMask(e){return this._getShapeMaskCache().get("string"==typeof e?e:e.id)}getShapeMaskedPageBounds(e){return"string"!=typeof e&&(e=e.id),this._getShapeMaskedPageBoundsCache().get(e)}_getShapeMaskedPageBoundsCache(){return this.store.createComputedCache("shapeMaskedPageBoundsCache",e=>{let t=this._getShapePageBoundsCache().get(e.id);if(!t)return;let i=this._getShapeMaskCache().get(e.id);if(i){if(0===i.length)return;let{corners:e}=t;if(e.every((e,t)=>e&&eV.B.Equals(e,i[t])))return t.clone();let s=(0,eZ.tY)(i,e);if(!s)return;return ez.xu.FromPoints(s)}return t})}getShapeAncestors(e,t=[]){let i="string"==typeof e?e:e.id,s=this.getShape(i);if(!s)return t;let r=s.parentId;if((0,eB.r5)(r))return t.reverse(),t;let n=this.store.get(r);return n?(t.push(n),this.getShapeAncestors(n,t)):t}findShapeAncestor(e,t){let i="string"==typeof e?e:e.id,s=this.getShape(i);if(!s)return;let r=s.parentId;if((0,eB.r5)(r))return;let n=this.getShape(r);if(n)return t(n)?n:this.findShapeAncestor(n,t)}hasAncestor(e,t){let i="string"==typeof e?e:e?.id,s=i&&this.getShape(i);return!!s&&(s.parentId===t||this.hasAncestor(this.getShapeParent(s),t))}findCommonAncestor(e,t){if(0===e.length)return;let i="string"==typeof e[0]?e:e.map(e=>e.id),s=(0,eb.oA)(i.map(e=>this.getShape(e)));if(1===s.length){let e=s[0].parentId;if((0,eB.r5)(e))return;return t?this.findShapeAncestor(s[0],t)?.id:e}let[r,...n]=s,a=this.getShapeParent(r);for(;a;){if(t&&!t(a)){a=this.getShapeParent(a);continue}if(n.every(e=>this.hasAncestor(e,a.id)))return a.id;a=this.getShapeParent(a)}}isShapeOrAncestorLocked(e){let t="string"==typeof e?this.getShape(e):e;return void 0!==t&&(!!t.isLocked||this.isShapeOrAncestorLocked(this.getShapeParent(t)))}_notVisibleShapes(){return(0,e1.A)(this)}getCulledShapes(){let e=this._notVisibleShapes().get(),t=this.getSelectedShapeIds(),i=this.getEditingShapeId(),s=new Set(e);return i&&s.delete(i),t.forEach(e=>{s.delete(e)}),s}getCurrentPageBounds(){let e;return this.getCurrentPageShapeIdsSorted().forEach(t=>{let i=this.getShapeMaskedPageBounds(t);i&&(e=e?e.expand(i):i.clone())}),e}getSelectedShapeAtPoint(e){let t=this.getSelectedShapeIds();return this.getCurrentPageShapesSorted().filter(e=>"group"!==e.type&&t.includes(e.id)).reverse().find(t=>this.isPointInShape(t,e,{hitInside:!0,margin:0}))}getShapeAtPoint(e,t={}){let i=this.getZoomLevel(),s=this.getViewportPageBounds(),{filter:r,margin:n=0,hitLocked:a=!1,hitLabels:h=!1,hitInside:o=!1,hitFrameInside:p=!1}=t,l=1/0,g=null,d=1/0,u=null,c=(t.renderingOnly?this.getCurrentPageRenderingShapesSorted():this.getCurrentPageShapesSorted()).filter(t=>{if(t.isLocked&&!a||this.isShapeHidden(t)||this.isShapeOfType(t,"group"))return!1;let i=this.getShapeMask(t);return(!i||!!(0,eY.Of)(e,i))&&(!r||r(t))});for(let t=c.length-1;t>=0;t--){let r;let a=c[t],S=this.getShapeGeometry(a),f=S instanceof eG.m,m=this.getPointInShapeSpace(a,e);if((this.isShapeOfType(a,"arrow")||this.isShapeOfType(a,"geo")&&"none"===a.props.fill)&&a.props.text.trim()){for(let e of S.children)if(e.isLabel&&e.isPointInBounds(m))return a}if(this.isShapeOfType(a,"frame")){if(Math.abs(S.distanceToPoint(m,o))<=n)return u||a;if(S.hitTestPoint(m,0,!0))return u||g||(p?a:void 0);continue}if(f){let e=1/0;for(let t of S.children){if(t.isLabel&&!h)continue;let i=t.distanceToPoint(m,o);i<e&&(e=i)}r=e}else r=0===n&&(S.bounds.w<1||S.bounds.h<1)?S.distanceToPoint(m,o):S.bounds.containsPoint(m,n)?S.distanceToPoint(m,o):1/0;if(S.isClosed){if(r<=n){if(S.isFilled||f&&S.children[0].isFilled)return u||a;if(this.getShapePageBounds(a).contains(s))continue;if(Math.abs(r)<n)Math.abs(r)<d&&(d=Math.abs(r),u=a);else if(!u){let{area:e}=S;e<l&&(l=e,g=a)}}}else if(r<this.options.hitTestMargin/i)return a}return u||g||void 0}getShapesAtPoint(e,t={}){return this.getCurrentPageShapes().filter(i=>!this.isShapeHidden(i)&&this.isPointInShape(i,e,t))}isPointInShape(e,t,i={}){let{hitInside:s=!1,margin:r=0}=i,n="string"==typeof e?e:e.id,a=this.getShapeMask(n);return(!a||!!(0,eY.Of)(t,a))&&this.getShapeGeometry(n).hitTestPoint(this.getPointInShapeSpace(e,t),r,s)}getPointInShapeSpace(e,t){let i="string"==typeof e?e:e.id;return this._getShapePageTransformCache().get(i).clone().invert().applyToPoint(t)}getPointInParentSpace(e,t){let i="string"==typeof e?e:e.id,s=this.getShape(i);if(!s)return new eV.B(0,0);if((0,eB.r5)(s.parentId))return eV.B.From(t);let r=this.getShapePageTransform(s.parentId);return r?r.clone().invert().applyToPoint(t):eV.B.From(t)}getCurrentPageShapes(){return Array.from(this.getCurrentPageShapeIds(),e=>this.store.get(e))}getCurrentPageShapesSorted(){let e=[],t=this.getSortedChildIdsForParent(this.getCurrentPageId());for(let i=0,s=t.length;i<s;i++)!function e(t,i,s){let r=t.getShape(i);if(!r)return;s.push(r);let n=t.getSortedChildIdsForParent(i);for(let i=0,r=n.length;i<r;i++)e(t,n[i],s)}(this,t[i],e);return e}getCurrentPageRenderingShapesSorted(){let e=this.getCulledShapes();return this.getCurrentPageShapesSorted().filter(({id:t})=>!e.has(t)&&!this.isShapeHidden(t))}isShapeOfType(e,t){let i="string"==typeof e?this.getShape(e):e;return!!i&&i.type===t}getShape(e){let t="string"==typeof e?e:e.id;if((0,eB.YT)(t))return this.store.get(t)}getShapeParent(e){let t="string"==typeof e?e:e?.id;if(!t)return;let i=this.getShape(t);if(void 0!==i&&(0,eB.YT)(i.parentId))return this.store.get(i.parentId)}getShapeNearestSibling(e,t){return t?t.parentId===e.parentId?t:this.findShapeAncestor(t,t=>t.parentId===e.parentId):void 0}isShapeInPage(e,t=this.getCurrentPageId()){let i="string"==typeof e?e:e.id,s=this.getShape(i);if(!s)return!1;let r=!1;if(s.parentId===t)r=!0;else{let e=this.getShape(s.parentId);for(;e;){if(e.parentId===t){r=!0;break}e=this.getShape(e.parentId)}}return r}getAncestorPageId(e){let t="string"==typeof e?e:e?.id,i=t&&this.getShape(t);if(i)return(0,eB.r5)(i.parentId)?i.parentId:this.getAncestorPageId(this.getShape(i.parentId))}reparentShapes(e,t,i){let s="string"==typeof e[0]?e:e.map(e=>e.id);if(0===s.length)return this;let r=[],n=(0,eB.r5)(t)?eD._.Identity():this.getShapePageTransform(t),a=n.rotation(),h=[],o=(0,eb.oA)(this.getSortedChildIdsForParent(t).map(e=>this.getShape(e)));if(i){let e=o.find(e=>e.index===i);if(e){let t=o[o.indexOf(e)+1];h=t?(0,eb.Xv)(i,t.index,s.length):(0,eb.vw)(i,s.length)}else{let e=o.sort(eb.hl).find(e=>e.index>i);h=e?(0,eb.Xv)(i,e.index,s.length):(0,eb.vw)(i,s.length)}}else{let e=o.length&&o[o.length-1];h=e?(0,eb.vw)(e.index,s.length):(0,eb.H$)(s.length)}let p=n.clone().invert(),l=(0,eb.oA)(s.map(e=>this.getShape(e)));return this.run(()=>{for(let e=0;e<l.length;e++){let i=l[e],s=this.getShapePageTransform(i);if(!s)continue;let n=s.point();if(!n)continue;let o=p.applyToPoint(n),g=s.rotation()-a;r.push({id:i.id,type:i.type,parentId:t,x:o.x,y:o.y,rotation:g,index:h[e]})}this.updateShapes(r)},{ignoreShapeLock:!0}),this}getHighestIndexForParent(e){let t="string"==typeof e?e:e.id,i=this._parentIdsToChildIds.get()[t];if(!i||0===i.length)return"a1";let s=this.getShape(i[i.length-1]);return(0,eb._L)(s.index)}getSortedChildIdsForParent(e){let t="string"==typeof e?e:e.id;return this._parentIdsToChildIds.get()[t]||ex.LZ}visitDescendants(e,t){let i="string"==typeof e?e:e.id;for(let e of this.getSortedChildIdsForParent(i))!1!==t(e)&&this.visitDescendants(e,t);return this}getShapeAndDescendantIds(e){let t=new Set;for(let i of e.map(e=>this.getShape(e)).sort(eb.hl))t.add(i.id),this.visitDescendants(i,e=>{t.add(e)});return t}getDroppingOverShape(e,t=[]){let i=this.getCurrentPageShapesSorted();for(let s=i.length-1;s>=0;s--){let r=i[s];if(this.isShapeHidden(r)||this.getSelectedShapeIds().includes(r.id)||!this.getShapeUtil(r).canDropShapes(r,t)||t.find(e=>e.id===r.id||this.hasAncestor(r,e.id)))continue;let n=this.getShapeMaskedPageBounds(r.id);if(n&&n.containsPoint(e)&&this.getShapeGeometry(r).hitTestPoint(this.getPointInShapeSpace(r,e),0,!0))return r}}getOutermostSelectableShape(e,t){let i="string"==typeof e?e:e.id,s=this.getShape(i),r=s,n=s,a=this.getFocusedGroup();for(;n;){if(this.isShapeOfType(n,"group")&&a?.id!==n.id&&!this.hasAncestor(a,n.id)&&(t?.(n)??!0))r=n;else if(a?.id===n.id)break;n=this.getShapeParent(n)}return r}_getBindingsIndexCache(){let e=(0,e0.f)(this);return this.store.createComputedCache("bindingsIndex",t=>e.get().get(t.id))}getBinding(e){return this.store.get(e)}getBindingsFromShape(e,t){let i="string"==typeof e?e:e.id;return this.getBindingsInvolvingShape(i).filter(e=>e.fromId===i&&e.type===t)}getBindingsToShape(e,t){let i="string"==typeof e?e:e.id;return this.getBindingsInvolvingShape(i).filter(e=>e.toId===i&&e.type===t)}getBindingsInvolvingShape(e,t){let i="string"==typeof e?e:e.id,s=this._getBindingsIndexCache().get(i)??ex.LZ;return t?s.filter(e=>e.type===t):s}createBindings(e){let t=[];for(let i of e){let e=this.getShape(i.fromId),s=this.getShape(i.toId);if(!e||!s||!this.canBindShapes({fromShape:e,toShape:s,binding:i}))continue;let r=this.getBindingUtil(i.type).getDefaultProps(),n=this.store.schema.types.binding.create({...i,id:i.id??(0,eB.vI)(),props:{...r,...i.props}});t.push(n)}return this.store.put(t),this}createBinding(e){return this.createBindings([e])}updateBindings(e){let t=[];for(let i of e){if(!i)continue;let e=this.getBinding(i.id);if(!e)continue;let s=tT(e,i);if(s===e)continue;let r=this.getShape(s.fromId),n=this.getShape(s.toId);r&&n&&this.canBindShapes({fromShape:r,toShape:n,binding:s})&&t.push(s)}return this.store.put(t),this}updateBinding(e){return this.updateBindings([e])}deleteBindings(e,{isolateShapes:t=!1}={}){let i=e.map(e=>"string"==typeof e?e:e.id);return t?this.store.atomic(()=>{for(let e of i){let t=this.getBinding(e);if(!t)continue;let i=this.getBindingUtil(t);i.onBeforeIsolateFromShape?.({binding:t,removedShape:this.getShape(t.toId)}),i.onBeforeIsolateToShape?.({binding:t,removedShape:this.getShape(t.fromId)}),this.store.remove([e])}}):this.store.remove(i),this}deleteBinding(e,t){return this.deleteBindings([e],t)}canBindShapes({fromShape:e,toShape:t,binding:i}){let s="string"==typeof e?e:e.type,r="string"==typeof t?t:t.type,n={fromShapeType:s,toShapeType:r,bindingType:"string"==typeof i?i:i.type};return s===r?this.getShapeUtil(s).canBind(n):this.getShapeUtil(s).canBind(n)&&this.getShapeUtil(r).canBind(n)}rotateShapesBy(e,t,i){let s="string"==typeof e[0]?e:e.map(e=>e.id);if(s.length<=0)return this;let r=(0,eJ.o)({editor:this,ids:s});return r&&(0,eJ.Z)({delta:t,snapshot:r,editor:this,stage:"one-off",centerOverride:i?.center}),this}getChangesToTranslateShape(e,t){let i=e,s=this.getShapeUtil(e);return i=tT(i,s.onTranslateStart?.(i)??void 0),i=tT(i,{id:e.id,type:e.type,x:t.x,y:t.y}),i=tT(i,s.onTranslate?.(e,i)??void 0),i=tT(i,s.onTranslateEnd?.(e,i)??void 0)}nudgeShapes(e,t){let i="string"==typeof e[0]?e:e.map(e=>e.id);if(i.length<=0)return this;let s=[];for(let e of i){let i=this.getShape(e),r=eV.B.From(t),n=this.getShapeParentTransform(i);n&&r.rot(-n.rotation()),s.push(this.getChangesToTranslateShape(i,r.add(i)))}return this.updateShapes(s),this}duplicateShapes(e,t){return this.run(()=>{let i="string"==typeof e[0]?e:e.map(e=>e.id);if(i.length<=0)return this;let s=new Set(i),r=this.getShapeAndDescendantIds(i),n=[...r].reverse(),a=new Map;for(let e of r)a.set(e,(0,eB.F1)());let{shapesToCreateWithOriginals:h,bindingsToCreate:o}=tB(this,r,e=>{let i=[];for(let t of e){let e=this.getBinding(t);if(!e)continue;let s=(0,eB.vI)();i.push({...e,id:s,fromId:(0,eb.kP)(a.get(e.fromId)),toId:(0,eb.kP)(a.get(e.toId))})}let r=[];for(let e of n){let i=(0,eb.kP)(a.get(e)),n=this.getShape(e);if(!n)continue;let h=0,o=0;if(t&&s.has(e)){let e=this.getShapeParentTransform(n),i=new eV.B(t.x,t.y).rot(-e.rotation());h=i.x,o=i.y}r.push({shape:{...n,id:i,x:n.x+h,y:n.y+o,index:"a1",parentId:a.get(n.parentId)??n.parentId},originalShape:n})}return{shapesToCreateWithOriginals:r,bindingsToCreate:i}});h.forEach(({shape:e,originalShape:t})=>{let i=t.parentId,s=this.getSortedChildIdsForParent(i),r=s.indexOf(t.id),n=s[r+1],a=n?this.getShape(n):void 0,h=(0,eb.eI)(t.index,a?.index);e.index=h});let p=h.map(({shape:e})=>e);if(p.length+this.getCurrentPageShapeIds().size>this.options.maxShapesPerPage){tx(this);return}if(this.createShapes(p),this.createBindings(o),this.setSelectedShapes((0,eb.oA)(i.map(e=>a.get(e)))),void 0!==t){let e=this.getSelectionPageBounds(),t=this.getViewportPageBounds();e&&!t.contains(e)&&this.centerOnPoint(e.center,{animation:{duration:this.options.animationMediumMs}})}}),this}moveShapesToPage(e,t){let i="string"==typeof e[0]?e:e.map(e=>e.id);if(0===i.length||this.getIsReadonly()||t===this.getCurrentPageId()||!this.store.has(t))return this;let s=this.getContentFromCurrentPage(i);if(!s)return this;if(this.getPageShapeIds(t).size+s.shapes.length>this.options.maxShapesPerPage)return tx(this,t),this;let r=this.getCamera().z;return this.run(()=>{this.deleteShapes(i),this.setCurrentPage(t),this.setFocusedGroup(null),this.selectNone(),this.putContentOntoCurrentPage(s,{select:!0,preserveIds:!0,preservePosition:!0}),this.setCamera({...this.getCamera(),z:r}),this.centerOnPoint(this.getSelectionRotatedPageBounds().center)}),this}toggleLock(e){let t="string"==typeof e[0]?e:e.map(e=>e.id);if(this.getIsReadonly()||0===t.length)return this;let i=!0,s=!0,r=[];for(let e of t){let t=this.getShape(e);t&&(r.push(t),t.isLocked?s=!1:i=!1)}return this.run(()=>{s?(this.updateShapes(r.map(e=>({id:e.id,type:e.type,isLocked:!0}))),this.setSelectedShapes([])):i?this.updateShapes(r.map(e=>({id:e.id,type:e.type,isLocked:!1}))):this.updateShapes(r.map(e=>({id:e.id,type:e.type,isLocked:!0})))}),this}sendToBack(e){let t="string"==typeof e[0]?e:e.map(e=>e.id),i=(0,eW.B)(this,"toBack",t);return i&&this.updateShapes(i),this}sendBackward(e){let t="string"==typeof e[0]?e:e.map(e=>e.id),i=(0,eW.B)(this,"backward",t);return i&&this.updateShapes(i),this}bringForward(e){let t="string"==typeof e[0]?e:e.map(e=>e.id),i=(0,eW.B)(this,"forward",t);return i&&this.updateShapes(i),this}bringToFront(e){let t="string"==typeof e[0]?e:e.map(e=>e.id),i=(0,eW.B)(this,"toFront",t);return i&&this.updateShapes(i),this}flipShapes(e,t){let i="string"==typeof e[0]?e:e.map(e=>e.id);if(this.getIsReadonly())return this;let s=(0,eb.oA)(i.map(e=>this.getShape(e)));if(!s.length)return this;s=(0,eb.oA)(s.map(e=>this.isShapeOfType(e,"group")?this.getSortedChildIdsForParent(e.id).map(e=>this.getShape(e)):e).flat());let r=ez.xu.Common((0,eb.oA)(s.map(e=>this.getShapePageBounds(e)))).center;return this.run(()=>{for(let e of s){let i=this.getShapeGeometry(e).bounds,s=this.getShapePageTransform(e.id);s&&this.resizeShape(e.id,{x:"horizontal"===t?-1:1,y:"vertical"===t?-1:1},{initialBounds:i,initialPageTransform:s,initialShape:e,mode:"scale_shape",isAspectRatioLocked:this.getShapeUtil(e).isAspectRatioLocked(e),scaleOrigin:r,scaleAxisRotation:0})}}),this}stackShapes(e,t,i){let s,r,n,a,h;let o="string"==typeof e[0]?e:e.map(e=>e.id);if(this.getIsReadonly())return this;let p=o.map(e=>this.getShape(e)).filter(e=>!!e&&this.getShapeUtil(e).canBeLaidOut(e)),l=p.length;if(0===i&&l<3||l<2)return this;let g=Object.fromEntries(p.map(e=>[e.id,this.getShapePageBounds(e)]));if("horizontal"===t?(s="x",r="minX",n="maxX",a="width"):(s="y",r="minY",n="maxY",a="height"),0===i){let e=[];p.sort((e,t)=>g[e.id][r]-g[t.id][r]);for(let t=0;t<l-1;t++){let i=p[t],s=p[t+1],a=g[i.id],h=g[s.id][r]-a[n],o=e.find(e=>e.gap===h);o?o.count++:e.push({gap:h,count:1})}let t=0;e.forEach(e=>{e.count>t&&(t=e.count,h=e.gap)}),1===t&&(h=Math.max(0,e.reduce((e,t)=>e+t.gap*t.count,0)/(l-1)))}else h=i;let d=[],u=g[p[0].id][n];return p.forEach((e,t)=>{if(0===t)return;let i={x:0,y:0};i[s]=u+h-g[e.id][s];let r=this.getShapeParent(e),n=r?eV.B.Rot(i,-this.getShapePageTransform(r).decompose().rotation):i,o=this.getShapeUtil(e).onTranslateStart?.(e);d.push(o?{...o,[s]:e[s]+n[s]}:{id:e.id,type:e.type,[s]:e[s]+n[s]}),u+=g[e.id][a]+h}),this.updateShapes(d),this}packShapes(e,t){let i,s,r;let n="string"==typeof e[0]?e:e.map(e=>e.id);if(this.getIsReadonly()||n.length<2)return this;let a=n.map(e=>this.getShape(e)).filter(e=>!!e&&this.getShapeUtil(e).canBeLaidOut(e)),h={},o={},p,l,g=0;for(let e=0;e<a.length;e++)p=a[e],l=this.getShapePageBounds(p),h[p.id]=l,o[p.id]=l.clone(),g+=l.width*l.height;let d=ez.xu.Common((0,eb.oA)(Object.values(h))),u=d.width;a.sort((e,t)=>h[t.id].height-h[e.id].height);let c=Math.max(Math.ceil(Math.sqrt(g/.95)),u),S=[new ez.xu(d.x,d.y,c,1/0)],f=0,m=0;for(let e=0;e<a.length;e++){l=o[(p=a[e]).id];for(let e=S.length-1;e>=0;e--)if(i=S[e],!(l.width>i.width)&&!(l.height>i.height)){l.x=i.x,l.y=i.y,m=Math.max(m,l.maxY),f=Math.max(f,l.maxX),l.width===i.width&&l.height===i.height?(s=S.pop(),e<S.length&&(S[e]=s)):l.height===i.height?(i.x+=l.width+t,i.width-=l.width+t):(l.width===i.width||S.push(new ez.xu(i.x+(l.width+t),i.y,i.width-(l.width+t),l.height)),i.y+=l.height+t,i.height-=l.height+t);break}}let y=ez.xu.Common(Object.values(o)),P=eV.B.Sub(d.center,y.center),I=[];for(let e=0;e<a.length;e++){l=h[(p=a[e]).id],r=o[p.id];let t=eV.B.Sub(r.point,l.point).add(P),i=this.getShapeParentTransform(p);i&&t.rot(-i.rotation());let s={id:p.id,type:p.type,x:p.x+t.x,y:p.y+t.y},n=this.getShapeUtil(p).onTranslateStart?.({...p,...s});n?I.push({...s,...n}):I.push(s)}return I.length&&this.updateShapes(I),this}alignShapes(e,t){let i="string"==typeof e[0]?e:e.map(e=>e.id);if(this.getIsReadonly()||i.length<2)return this;let s=(0,eb.oA)(i.map(e=>this.getShape(e))),r=Object.fromEntries(s.map(e=>[e.id,this.getShapePageBounds(e)])),n=ez.xu.Common((0,eb.oA)(Object.values(r))),a=[];return s.forEach(e=>{let i=r[e.id];if(!i)return;let s={x:0,y:0};switch(t){case"top":s.y=n.minY-i.minY;break;case"center-vertical":s.y=n.midY-i.minY-i.height/2;break;case"bottom":s.y=n.maxY-i.minY-i.height;break;case"left":s.x=n.minX-i.minX;break;case"center-horizontal":s.x=n.midX-i.minX-i.width/2;break;case"right":s.x=n.maxX-i.minX-i.width}let h=this.getShapeParent(e),o=h?eV.B.Rot(s,-this.getShapePageTransform(h).decompose().rotation):s;a.push(this.getChangesToTranslateShape(e,eV.B.Add(e,o)))}),this.updateShapes(a),this}distributeShapes(e,t){let i,s,r,n,a;let h="string"==typeof e[0]?e:e.map(e=>e.id);if(this.getIsReadonly()||h.length<3)return this;let o=h.length,p=(0,eb.oA)(h.map(e=>this.getShape(e))),l=Object.fromEntries(p.map(e=>[e.id,this.getShapePageBounds(e)]));"horizontal"===t?(i="x",s="minX",r="maxX",n="midX",a="width"):(i="y",s="minY",r="maxY",n="midY",a="height");let g=[],d=p.sort((e,t)=>l[e.id][s]-l[t.id][s])[0],u=p.sort((e,t)=>l[t.id][r]-l[e.id][r])[0],c=l[d.id][n],S=(l[u.id][n]-c)/(o-1),f=c+S;return p.filter(e=>e!==d&&e!==u).sort((e,t)=>l[e.id][n]-l[t.id][n]).forEach((e,t)=>{let s={x:0,y:0};s[i]=f+S*t-l[e.id][a]/2-l[e.id][i];let r=this.getShapeParent(e),n=r?eV.B.Rot(s,-this.getShapePageTransform(r).rotation()):s;g.push(this.getChangesToTranslateShape(e,eV.B.Add(e,n)))}),this.updateShapes(g),this}stretchShapes(e,t){let i="string"==typeof e[0]?e:e.map(e=>e.id);if(this.getIsReadonly()||i.length<2)return this;let s=(0,eb.oA)(i.map(e=>this.getShape(e))),r=Object.fromEntries(i.map(e=>[e,this.getShapeGeometry(e).bounds])),n=Object.fromEntries(i.map(e=>[e,this.getShapePageBounds(e)])),a=ez.xu.Common((0,eb.oA)(Object.values(n)));switch(t){case"vertical":this.run(()=>{for(let e of s){if(this.getShapePageTransform(e).rotation()%eY.yo)continue;let t=r[e.id],i=n[e.id],s=new eV.B(0,a.minY-i.minY),h=this.getShapeParentTransform(e);h&&s.rot(-h.rotation());let{x:o,y:p}=eV.B.Add(s,e);this.updateShapes([{id:e.id,type:e.type,x:o,y:p}]);let l=new eV.B(1,a.height/i.height);this.resizeShape(e.id,l,{initialBounds:t,scaleOrigin:new eV.B(i.center.x,a.minY),isAspectRatioLocked:this.getShapeUtil(e).isAspectRatioLocked(e),scaleAxisRotation:0})}});break;case"horizontal":this.run(()=>{for(let e of s){let t=r[e.id],i=n[e.id];if(this.getShapePageTransform(e).rotation()%eY.yo)continue;let s=new eV.B(a.minX-i.minX,0),h=this.getShapeParentTransform(e);h&&s.rot(-h.rotation());let{x:o,y:p}=eV.B.Add(s,e);this.updateShapes([{id:e.id,type:e.type,x:o,y:p}]);let l=new eV.B(a.width/i.width,1);this.resizeShape(e.id,l,{initialBounds:t,scaleOrigin:new eV.B(a.minX,i.center.y),isAspectRatioLocked:this.getShapeUtil(e).isAspectRatioLocked(e),scaleAxisRotation:0})}})}return this}resizeShape(e,t,i={}){let s="string"==typeof e?e:e.id;if(this.getIsReadonly())return this;Number.isFinite(t.x)||(t=new eV.B(1,t.y)),Number.isFinite(t.y)||(t=new eV.B(t.x,1));let r=i.initialShape??this.getShape(s);if(!r)return this;let n=i.scaleOrigin??this.getShapePageBounds(s)?.center;if(!n)return this;let a=i.initialPageTransform?eD._.Cast(i.initialPageTransform):this.getShapePageTransform(s);if(!a)return this;let h=a.rotation();if(null==h)return this;let o=i.scaleAxisRotation??h,p=i.initialBounds??this.getShapeGeometry(s).bounds;if(!p)return this;let l=i.isAspectRatioLocked??this.getShapeUtil(r).isAspectRatioLocked(r);if(!(0,eY._G)(h,o))return this._resizeUnalignedShape(s,t,{...i,initialBounds:p,scaleOrigin:n,scaleAxisRotation:o,initialPageTransform:a,isAspectRatioLocked:l,initialShape:r});let g=this.getShapeUtil(r);if(l&&(t=Math.abs(t.x)>Math.abs(t.y)?new eV.B(t.x,Math.sign(t.y)*Math.abs(t.x)):new eV.B(Math.sign(t.x)*Math.abs(t.y),t.y)),g.onResize&&g.canResize(r)){let e=this._scalePagePoint(eD._.applyToPoint(a,new eV.B(0,0)),n,t,o),l=this.getPointInParentSpace(r.id,e),d=new eV.B(t.x,t.y),u=(0,eY.C2)((h-o)%Math.PI,0);d.x=u?t.x:t.y,d.y=u?t.y:t.x;let c=eD._.applyToPoint(a,new eV.B),{x:S,y:f}=this.getPointInParentSpace(r.id,c),m=r;i.skipStartAndEndCallbacks||(m=tT(r,g.onResizeStart?.(r)??void 0)),m=tT(m,{id:s,type:r.type,x:l.x,y:l.y,...g.onResize({...r,x:S,y:f},{newPoint:l,handle:i.dragHandle??"bottom_right",mode:i.mode??"scale_shape",scaleX:d.x,scaleY:d.y,initialBounds:p,initialShape:r})}),i.skipStartAndEndCallbacks||(m=tT(m,g.onResizeEnd?.(r,m)??void 0)),this.updateShapes([m])}else{let e=eD._.applyToPoint(a,p.center),i=this._scalePagePoint(e,n,t,o),h=this.getPointInParentSpace(r.id,e),l=this.getPointInParentSpace(r.id,i),g=eV.B.Sub(l,h);this.updateShapes([{id:s,type:r.type,x:r.x+g.x,y:r.y+g.y}])}return this}_scalePagePoint(e,t,i,s){let r=eV.B.RotWith(e,t,-s).sub(t),n=eV.B.MulV(r,i);return eV.B.Add(n,t).rotWith(t,s)}_resizeUnalignedShape(e,t,i){let{type:s}=i.initialShape,r=new eV.B(t.x,t.y);if(Math.abs(t.x)>Math.abs(t.y)?r.x=Math.sign(t.x)*Math.abs(t.y):r.y=Math.sign(t.y)*Math.abs(t.x),this.resizeShape(e,r,{initialShape:i.initialShape,initialBounds:i.initialBounds,isAspectRatioLocked:i.isAspectRatioLocked}),Math.sign(t.x)*Math.sign(t.y)<0){let{rotation:t}=eD._.Decompose(i.initialPageTransform);t-=2*t,this.updateShapes([{id:e,type:s,rotation:t}])}let n=eD._.applyToPoint(i.initialPageTransform,i.initialBounds.center),a=this._scalePagePoint(n,i.scaleOrigin,t,i.scaleAxisRotation),h=this.getShapePageBounds(e),o=this.getShapePageTransform(e),p=h.center,l=o.point();if(!p||!l)return this;let g=eV.B.Sub(a,p),d=eV.B.Add(l,g),{x:u,y:c}=this.getPointInParentSpace(e,d);return this.updateShapes([{id:e,type:s,x:u,y:c}]),this}getInitialMetaForShape(e){return{}}createShape(e){return this.createShapes([e]),this}createShapes(e){if(!Array.isArray(e))throw Error("Editor.createShapes: must provide an array of shapes or shape partials");if(this.getIsReadonly()||e.length<=0)return this;let t=this.getCurrentPageShapeIds();if(e.length+t.size>this.options.maxShapesPerPage)return tx(this),this;let i=this.getFocusedGroupId();return this.run(()=>{let t=this.getCurrentPageShapesSorted(),s=e.map(s=>{if(s.id||(s={id:(0,eB.F1)(),...s}),!s.parentId||!(this.store.has(s.parentId)||e.some(e=>e.id===s.parentId))){let e=this.getFocusedGroupId();for(let i=t.length-1;i>=0;i--){let r=t[i];if(!this.isShapeHidden(r)&&this.getShapeUtil(r).canReceiveNewChildrenOfType(r,s.type)&&this.isPointInShape(r,{x:s.x??0,y:s.y??0},{margin:0,hitInside:!0})){e=r.id;break}}let r=s.parentId;if(e===s.id&&(e=i),e!==r&&((s={...s}).parentId=e,(0,eB.YT)(e))){let t=this.getPointInShapeSpace(this.getShape(e),{x:s.x??0,y:s.y??0});s.x=t.x,s.y=t.y,s.rotation=-this.getShapePageTransform(e).rotation()+(s.rotation??0)}}return s}),r=new Map,n=[],{opacityForNextShape:a}=this.getInstanceState();for(let e of s){let t=this.getShapeUtil(e),s=e.index;if(!s){let t=e.parentId??i;r.has(t)||r.set(t,this.getHighestIndexForParent(t)),s=r.get(t),r.set(t,(0,eb._L)(s))}let h=t.getDefaultProps();for(let[t,i]of this.styleProps[e.type])h[i]=this.getStyleForNextShape(t);let o=this.store.schema.types.shape.create({...e,index:s,opacity:e.opacity??a,parentId:e.parentId??i,props:"props"in e?{...h,...e.props}:h});if(void 0===o.index)throw Error("no index!");let p=this.getShapeUtil(o).onBeforeCreate?.(o);p&&(o=p),n.push(o)}n.forEach(e=>{e.meta={...this.getInitialMetaForShape(e),...e.meta}}),this.store.put(n)}),this}animateShape(e,t={animation:eO.Xy}){return this.animateShapes([e],t)}animateShapes(e,t={animation:eO.Xy}){let i,s,r;if(!t.animation)return this;let{duration:n=500,easing:a=eH.L.linear}=t.animation,h=(0,eb.EL)(),o=n,p=[];for(let t=0,i=e.length;t<i;t++){if(!(s=e[t]))continue;let i=this.getShape(s.id);i&&(r={start:(0,eb.v4)(i),end:tT((0,eb.v4)(i),s)},p.push(r),this.animatingShapes.set(i.id,h))}let l=t=>{if((o-=t)<0){let{animatingShapes:t}=this,i=e.filter(e=>e&&t.get(e.id)===h);i.length&&this.updateShapes(i),this.off("tick",l);return}i=a(1-o/n);let{animatingShapes:s}=this,r=[];for(let e=0,t=p.length;e<t;e++){let{start:t,end:n}=p[e];s.get(t.id)===h&&r.push({...n,x:t.x+(n.x-t.x)*i,y:t.y+(n.y-t.y)*i,opacity:t.opacity+(n.opacity-t.opacity)*i,rotation:t.rotation+(n.rotation-t.rotation)*i,props:this.getShapeUtil(n).getInterpolatedProps?.(t,n,i)??n.props})}this._updateShapes(r)};return this.on("tick",l),this}groupShapes(e,t={}){let{groupId:i=(0,eB.F1)(),select:s=!0}=t;if(!Array.isArray(e))throw Error("Editor.groupShapes: must provide an array of shapes or shape ids");if(this.getIsReadonly())return this;let r="string"==typeof e[0]?e:e.map(e=>e.id);if(r.length<=1)return this;let n=(0,eb.oA)((this._shouldIgnoreShapeLock?r:this._getUnlockedShapeIds(r)).map(e=>this.getShape(e))),a=n.sort(eb.hl).map(e=>e.id),{x:h,y:o}=ez.xu.Common((0,eb.oA)(n.map(e=>this.getShapePageBounds(e)))).point,p=this.findCommonAncestor(n)??this.getCurrentPageId();if("select"!==this.getCurrentToolId())return this;this.isIn("select.idle")||this.cancel();let l=n.filter(e=>e.parentId===p).sort(eb.hl),g=l[l.length-1]?.index;return this.run(()=>{this.createShapes([{id:i,type:"group",parentId:p,index:g,x:h,y:o,opacity:1,props:{}}]),this.reparentShapes(a,i),s&&this.select(i)}),this}ungroupShapes(e,t={}){if(this.getIsReadonly())return this;let{select:i=!0}=t,s="string"==typeof e[0]?e:e.map(e=>e.id),r=(0,eb.oA)((this._shouldIgnoreShapeLock?s:this._getUnlockedShapeIds(s)).map(e=>this.getShape(e)));if(0===r.length||"select"!==this.getCurrentToolId())return this;this.isIn("select.idle")||this.cancel();let n=new Set,a=[];return r.forEach(e=>{this.isShapeOfType(e,"group")?a.push(e):n.add(e.id)}),0===a.length||this.run(()=>{let e;for(let t=0,i=a.length;t<i;t++){e=a[t];let i=this.getSortedChildIdsForParent(e.id);for(let e=0,t=i.length;e<t;e++)n.add(i[e]);this.reparentShapes(i,e.parentId,e.index)}this.deleteShapes(a.map(e=>e.id)),i&&this.select(...n)}),this}updateShape(e){return this.updateShapes([e]),this}updateShapes(e){let t=Array(e.length);for(let i=0,s=e.length;i<s;i++){let s=e[i];if(!s)continue;let r=this.getShape(s.id);if(r){if(!this._shouldIgnoreShapeLock){if(r.isLocked){if(!(Object.hasOwn(s,"isLocked")&&!s.isLocked))continue}else if(this.isShapeOrAncestorLocked(r))continue}this.animatingShapes.delete(s.id),t.push(s)}}return this._updateShapes(t),this}_updateShapes(e){this.getIsReadonly()||this.run(()=>{let t,i;let s=[];for(let r=0,n=e.length;r<n;r++){let n=e[r];n&&(t=this.getShape(n.id))&&(i=tT(t,n))!==t&&(i=this.getShapeUtil(t).onBeforeUpdate?.(t,i)??i,s.push(i))}this.store.put(s)})}_getUnlockedShapeIds(e){return e.filter(e=>!this.getShape(e)?.isLocked)}deleteShapes(e){if(this.getIsReadonly())return this;if(!Array.isArray(e))throw Error("Editor.deleteShapes: must provide an array of shapes or shapeIds");let t="string"==typeof e[0]?e:e.map(e=>e.id),i=this._shouldIgnoreShapeLock?t:this._getUnlockedShapeIds(t);if(0===i.length)return this;let s=new Set(i);for(let e of i)this.visitDescendants(e,e=>{s.add(e)});return this.run(()=>this.store.remove([...s]))}deleteShape(e){return this.deleteShapes(["string"==typeof e?e:e.id]),this}_extractSharedStyles(e,t){if(this.isShapeOfType(e,"group")){let i=this._parentIdsToChildIds.get()[e.id];if(i)for(let e=0,s=i.length;e<s;e++)this._extractSharedStyles(this.getShape(i[e]),t)}else for(let[i,s]of this.styleProps[e.type])t.applyValue(i,(0,eb.eg)(e.props,s))}_getSelectionSharedStyles(){let e=this.getSelectedShapes(),t=new eN.o;for(let i of e)this._extractSharedStyles(i,t);return t}getStyleForNextShape(e){let t=this.getInstanceState().stylesForNextShape[e.id];return void 0===t?e.defaultValue:t}getShapeStyleIfExists(e,t){let i=this.styleProps[e.type].get(t);if(void 0!==i)return(0,eb.eg)(e.props,i)}getSharedStyles(){if(this.isIn("select")&&this.getSelectedShapeIds().length>0)return this._getSelectionSharedStyles();let e=this.root.getCurrent(),t=new eN.o;if(!e)return t;if(e.shapeType)for(let i of this.styleProps[e.shapeType].keys())t.applyValue(i,this.getStyleForNextShape(i));return t}getSharedOpacity(){if(this.isIn("select")&&this.getSelectedShapeIds().length>0){let e=[],t=i=>{let s=this.getShape(i);if(s){if(this.isShapeOfType(s,"group"))for(let e of this.getSortedChildIdsForParent(s.id))t(e);else e.push(s)}};for(let e of this.getSelectedShapeIds())t(e);let i=null;for(let t of e)if(null===i)i=t.opacity;else if(i!==t.opacity)return{type:"mixed"};if(null!==i)return{type:"shared",value:i}}return{type:"shared",value:this.getInstanceState().opacityForNextShape}}setOpacityForNextShapes(e,t){return this.updateInstanceState({opacityForNextShape:e},t),this}setOpacityForSelectedShapes(e){let t=this.getSelectedShapes();if(t.length>0){let i=[],s=e=>{if(this.isShapeOfType(e,"group"))for(let t of this.getSortedChildIdsForParent(e))s(this.getShape(t));else i.push(e)};for(let e of t)s(e);this.updateShapes(i.map(t=>({id:t.id,type:t.type,opacity:e})))}return this}setStyleForNextShapes(e,t,i){let s=this.getInstanceState().stylesForNextShape;return this.updateInstanceState({stylesForNextShape:{...s,[e.id]:t}},i),this}setStyleForSelectedShapes(e,t){let i=this.getSelectedShapes();if(i.length>0){let s=[],r=i=>{if(this.isShapeOfType(i,"group"))for(let e of this.getSortedChildIdsForParent(i.id))r(this.getShape(e));else{let r=this.getShapeUtil(i),n=this.styleProps[i.type].get(e);if(n){let e={id:i.id,type:i.type,props:{[n]:t}};s.push({util:r,originalShape:i,updatePartial:e})}}};for(let e of i)r(e);this.updateShapes(s.map(({updatePartial:e})=>e))}return this}registerExternalAssetHandler(e,t){return this.externalAssetContentHandlers[e]=t,this}createTemporaryAssetPreview(e,t){if(this.temporaryAssetPreview.has(e))return this.temporaryAssetPreview.get(e);let i=URL.createObjectURL(t);return this.temporaryAssetPreview.set(e,i),setTimeout(()=>{this.temporaryAssetPreview.delete(e),URL.revokeObjectURL(i)},this.options.temporaryAssetPreviewLifetimeMs),i}getTemporaryAssetPreview(e){return this.temporaryAssetPreview.get(e)}async getAssetForExternalContent(e){return await this.externalAssetContentHandlers[e.type]?.(e)}hasExternalAssetHandler(e){return!!this.externalAssetContentHandlers[e]}registerExternalContentHandler(e,t){return this.externalContentHandlers[e]=t,this}async putExternalContent(e){return this.externalContentHandlers[e.type]?.(e)}getContentFromCurrentPage(e){let t="string"==typeof e[0]?e:e.map(e=>e.id);if(!t||0===t.length)return;let i=this.getShapeAndDescendantIds(t);return tB(this,i,e=>{let t=[];for(let i of e){let e=this.getBinding(i);e&&t.push(e)}let s=[],r=[];for(let e of i){let t=this.getShape(e);if(t){if(i.has(t.parentId))r.push(t);else{let e=this.getShapePageTransform(t.id),i=e.point();r.push({...t,x:i.x,y:i.y,rotation:e.rotation(),parentId:this.getCurrentPageId()}),s.push(t.id)}}}let n=[],a=new Set;for(let e of r){if(!("assetId"in e.props))continue;let t=e.props.assetId;if(!t||a.has(t))continue;a.add(t);let i=this.getAsset(t);i&&n.push(i)}return{schema:this.store.schema.serialize(),shapes:r,rootShapeIds:s,bindings:t,assets:n}})}async resolveAssetsInContent(e){if(!e)return;let t=[];return await Promise.allSettled(e.assets.map(async e=>{if("image"!==e.type&&"video"!==e.type||e.props.src?.startsWith("data:image")||e.props.src?.startsWith("http"))t.push(e);else{let i=(0,eb.v4)(e),s=await this.store.props.assets.resolve(e,{screenScale:1,steppedScreenScale:1,dpr:1,networkEffectiveType:null,shouldResolveToOriginal:!0});i.props.src=await eb.P6.blobToDataUrl(await (0,eb.he)(s).then(e=>e.blob())),t.push(i)}})),e.assets=t,e}putContentOntoCurrentPage(e,t={}){if(this.getIsReadonly())return this;if(!e.schema)throw Error("Could not put content:\ncontent is missing a schema.");let{select:i=!1,preserveIds:s=!1,preservePosition:r=!1}=t,{point:n}=t,a=this.getCurrentPageId(),{rootShapeIds:h}=e,o=[],p=[],l=[],g={store:{...Object.fromEntries(e.assets.map(e=>[e.id,e])),...Object.fromEntries(e.shapes.map(e=>[e.id,e])),...Object.fromEntries(e.bindings?.map(e=>[e.id,e])??[])},schema:e.schema},d=this.store.schema.migrateStoreSnapshot(g);if("error"===d.type)throw Error("Could not put content: could not migrate content");for(let e of Object.values(d.value))switch(e.typeName){case"asset":o.push(e);break;case"shape":p.push(e);break;case"binding":l.push(e)}let u=new Map(s?p.map(e=>[e.id,e.id]):p.map(e=>[e.id,(0,eB.F1)()])),c=new Map(s?l.map(e=>[e.id,e.id]):l.map(e=>[e.id,(0,eB.vI)()])),S=this.getCurrentPageId(),f=1/0,m=[];for(let e of this.getSelectedShapes()){if(0===f)break;let t=this.isShapeOfType(e,"frame"),i=this.getShapeAncestors(e);t&&i.push(e);let s=t?i.length+1:i.length;if(s<f)f=s,m=i,S=t?e.id:e.parentId;else if(s===f){if(m.length!==i.length)throw Error(`Ancestors: ${m.length} !== ${i.length}`);if(0===m.length){S=a;break}S=a;for(let e=0;e<m.length&&i[e]===m[e];e++)S=i[e].id}}let y=!1;if(!(0,eB.r5)(S)){let e=this.getShape(S);if(e){if(this.getViewportPageBounds().includes(this.getShapePageBounds(e))){if(1===h.length){let t=p.find(e=>e.id===h[0]);this.isShapeOfType(e,"frame")&&this.isShapeOfType(t,"frame")&&t.props.w===e?.props.w&&t.props.h===e?.props.h&&(y=!0)}}else S=a}else S=a}y||(y=u.has(S)),y&&(S=this.getShape(S).parentId);let P=this.getHighestIndexForParent(S),I=[],C=p.map(e=>{let t=u.get(e.id),i={...e,id:t};return h.includes(e.id)&&(i.parentId=a,I.push(i)),u.has(i.parentId)?i.parentId=u.get(e.parentId):(h.push(i.id),i.index=P,P=(0,eb._L)(P)),i});if(C.length+this.getCurrentPageShapeIds().size>this.options.maxShapesPerPage)return tx(this),this;let w=l.map(e=>({...e,id:(0,eb.kP)(c.get(e.id)),fromId:(0,eb.kP)(u.get(e.fromId)),toId:(0,eb.kP)(u.get(e.toId))})),_=[],T=[];for(let e of o)this.store.has(e.id)||(("image"===e.type||"video"===e.type)&&e.props.src?.startsWith("data:image")&&(T.push((0,eb.v4)(e)),e.props.src=null),_.push(e));return Promise.allSettled(T.map(async e=>{let t=await (0,eX.B)(e.props.src,e.props.name,e.props.mimeType??"image/png"),i=await this.getAssetForExternalContent({type:"file",file:t,assetId:e.id});if(!i){this.deleteAssets([e.id]);return}this.updateAssets([{...i,id:e.id}])})),this.run(()=>{_.length>0&&this.createAssets(_),this.createShapes(C),this.createBindings(w),i&&this.select(...I.map(e=>e.id)),S!==a&&this.reparentShapes(I.map(e=>e.id),S);let e=C.map(e=>this.getShape(e.id)),t=ez.xu.Common(e.map(e=>this.getShapePageBounds(e)));if(void 0===n){if((0,eB.r5)(S)){let e=this.getViewportPageBounds();n=r||e.includes(ez.xu.From(t))?t.center:e.center}else{let e=this.getShape(S);n=eD._.applyToPoint(this.getShapePageTransform(e),this.getShapeGeometry(e).bounds.center)}}if(1===I.length){let e=I[0];if(this.isShapeOfType(e,"frame"))for(;this.getShapesAtPoint(n).some(t=>this.isShapeOfType(t,"frame")&&t.props.w===e.props.w&&t.props.h===e.props.h);)n.x+=t.w+16}let s=ez.xu.Common((0,eb.oA)(I.map(({id:e})=>this.getShapePageBounds(e)))).center,h=eV.B.Sub(n,s);this.updateShapes(I.map(({id:e})=>{let t=this.getShape(e),i=this.getShapeParentTransform(e).decompose().rotation,s=eV.B.Rot(h,-i);return{id:t.id,type:t.type,x:t.x+s.x,y:t.y+s.y}}))}),this}async getSvgElement(e,t={}){let i="string"==typeof e[0]?e:e.map(e=>e.id);if(0!==i.length)return(0,eE.$)(this,i,t)}async getSvgString(e,t={}){let i=await this.getSvgElement(e,t);if(i)return{svg:new XMLSerializer().serializeToString(i.svg),width:i.width,height:i.height}}async getSvg(e,t={}){let i=await this.getSvgElement(e,t);if(i)return i.svg}_updateInputsFromEvent(e){let{pointerVelocity:t,previousScreenPoint:i,previousPagePoint:s,currentScreenPoint:r,currentPagePoint:n}=this.inputs,{screenBounds:a}=this.store.unsafeGetWithoutCapture(eB.PQ),{x:h,y:o,z:p}=(0,ex.dy)(()=>this.getCamera()),l=e.point.x-a.x,g=e.point.y-a.y,d=e.point.z??.5;i.setTo(r),s.setTo(n),r.set(l,g);let u=l/p-h,c=g/p-o;isFinite(u)&&isFinite(c)&&n.set(u,c,d),this.inputs.isPen="pointer"===e.type&&e.isPen,("pointer_down"===e.name||this.inputs.isPinching)&&(t.set(0,0),this.inputs.originScreenPoint.setTo(r),this.inputs.originPagePoint.setTo(n)),this.run(()=>{this.store.put([{id:eB.LV,typeName:"pointer",x:n.x,y:n.y,lastActivityTimestamp:"pointer"===e.type&&e.pointerId===eO.CK.CAMERA_MOVE?this.store.unsafeGetWithoutCapture(eB.LV)?.lastActivityTimestamp??this._tickManager.now:this._tickManager.now,meta:{}}])},{history:"ignore"})}cancel(){return this.dispatch({type:"misc",name:"cancel"}),this}interrupt(){return this.dispatch({type:"misc",name:"interrupt"}),this}complete(){return this.dispatch({type:"misc",name:"complete"}),this}focus({focusContainer:e=!0}={}){return this.getIsFocused()||(e&&this.focusManager.focus(),this.updateInstanceState({isFocused:!0})),this}blur({blurContainer:e=!0}={}){return this.getIsFocused()&&(e?this.focusManager.blur():this.complete(),this.updateInstanceState({isFocused:!1})),this}getIsFocused(){return this.getInstanceState().isFocused}getIsReadonly(){return this.getInstanceState().isReadonly}getSnapshot(){return(0,ek.v)(this.store)}loadSnapshot(e,t){return(0,ek.w)(this.store,e,t),this}_zoomToFitPageContentAt100Percent(){let e=this.getCurrentPageBounds();e&&this.zoomToBounds(e,{immediate:!0,targetZoom:this.getBaseZoom()})}_navigateToDeepLink(e){this.run(()=>{switch(e.type){case"page":{let t=this.getPage(e.pageId);t&&this.setCurrentPage(t),this._zoomToFitPageContentAt100Percent();return}case"shapes":{let t=(0,eb.oA)(e.shapeIds.map(e=>this.getShape(e))),i={};for(let e of t){let t=this.getAncestorPageId(e);t&&(i[t]??=[],i[t].push(e))}let[s,r]=Object.entries(i).sort(([e,t],[i,s])=>s.length-t.length)[0]??["",[]];if(s&&r.length){this.setCurrentPage(s);let e=ez.xu.Common(r.map(e=>this.getShapePageBounds(e)));this.zoomToBounds(e,{immediate:!0,targetZoom:this.getBaseZoom()})}else this._zoomToFitPageContentAt100Percent();return}case"viewport":if(e.pageId){if(!this.getPage(e.pageId)){this._zoomToFitPageContentAt100Percent();return}this.setCurrentPage(e.pageId)}this.zoomToBounds(e.bounds,{immediate:!0,inset:0});return;default:(0,eb.iP)(e)}})}navigateToDeepLink(e){if(e&&"type"in e)return this._navigateToDeepLink(e),this;let t=new URL(e?.url??window.location.href).searchParams.get(e?.param??"d");if(!t)return this._zoomToFitPageContentAt100Percent(),this;try{this._navigateToDeepLink((0,eq.Y)(t))}catch(e){console.warn(e),this._zoomToFitPageContentAt100Percent()}return this}createDeepLink(e){let t=new URL(e?.url??window.location.href);return t.searchParams.set(e?.param??"d",(0,eq.y)(e?.to??{type:"viewport",pageId:1===this.options.maxPages?void 0:this.getCurrentPageId(),bounds:this.getViewportPageBounds()})),t}registerDeepLinkListener(e){if(e?.getUrl&&!e?.onChange)throw Error("[tldraw:urlStateSync] If you specify getUrl, you must also specify the onChange callback.");let t=(0,ex.Fl)("url with state",()=>{let t=e?.getUrl?.(this)??window.location.href;return this.createDeepLink({param:e?.param,url:t,to:e?.getTarget?.(this)}).toString()}),i=e?.onChange??(()=>{let t=this.createDeepLink({param:e?.param,to:e?.getTarget?.(this)});window.history.replaceState({},document.title,t.toString())}),s=(0,eb.Ds)(e=>e(),e?.debounceMs??500),r=(0,ex.Ym)("update url on state change",()=>i(new URL(t.get()),this),{scheduleEffect:s});return()=>{r(),s.cancel()}}cancelDoubleClick(){this._clickManager.cancelDoubleClickTimeout()}_setShiftKeyTimeout(){this.inputs.shiftKey=!1,this.dispatch({type:"keyboard",name:"key_up",key:"Shift",shiftKey:this.inputs.shiftKey,ctrlKey:this.inputs.ctrlKey,altKey:this.inputs.altKey,metaKey:this.inputs.metaKey,accelKey:(0,e$.q)(this.inputs),code:"ShiftLeft"})}_setAltKeyTimeout(){this.inputs.altKey=!1,this.dispatch({type:"keyboard",name:"key_up",key:"Alt",shiftKey:this.inputs.shiftKey,ctrlKey:this.inputs.ctrlKey,altKey:this.inputs.altKey,metaKey:this.inputs.metaKey,accelKey:(0,e$.q)(this.inputs),code:"AltLeft"})}_setCtrlKeyTimeout(){this.inputs.ctrlKey=!1,this.dispatch({type:"keyboard",name:"key_up",key:"Ctrl",shiftKey:this.inputs.shiftKey,ctrlKey:this.inputs.ctrlKey,altKey:this.inputs.altKey,metaKey:this.inputs.metaKey,accelKey:(0,e$.q)(this.inputs),code:"ControlLeft"})}_setMetaKeyTimeout(){this.inputs.metaKey=!1,this.dispatch({type:"keyboard",name:"key_up",key:"Meta",shiftKey:this.inputs.shiftKey,ctrlKey:this.inputs.ctrlKey,altKey:this.inputs.altKey,metaKey:this.inputs.metaKey,accelKey:(0,e$.q)(this.inputs),code:"MetaLeft"})}dispatch(e){return this._pendingEventsForNextTick.push(e),"pointer"===e.type&&"pointer_move"===e.name||"wheel"===e.type||"pinch"===e.type||this._flushEventsForTick(0),this}_flushEventsForTick(e){this.run(()=>{if(this._pendingEventsForNextTick.length>0){let e=[...this._pendingEventsForNextTick];for(let t of(this._pendingEventsForNextTick.length=0,e))this._flushEventForTick(t)}e>0&&this.root.handleEvent({type:"misc",name:"tick",elapsed:e}),this.scribbles.tick(e)})}_flushEventForTick(e){if(this.getCrashingError())return this;let{inputs:t}=this,{type:i}=e;if("misc"===e.type){("cancel"===e.name||"complete"===e.name)&&(this.inputs.isDragging=!1,this.inputs.isPanning&&(this.inputs.isPanning=!1,this.inputs.isSpacebarPanning=!1,this.setCursor({type:this._prevCursor,rotation:0}))),this.root.handleEvent(e);return}e.shiftKey?(clearTimeout(this._shiftKeyTimeout),this._shiftKeyTimeout=-1,t.shiftKey=!0):!e.shiftKey&&t.shiftKey&&-1===this._shiftKeyTimeout&&(this._shiftKeyTimeout=this.timers.setTimeout(this._setShiftKeyTimeout,150)),e.altKey?(clearTimeout(this._altKeyTimeout),this._altKeyTimeout=-1,t.altKey=!0):!e.altKey&&t.altKey&&-1===this._altKeyTimeout&&(this._altKeyTimeout=this.timers.setTimeout(this._setAltKeyTimeout,150)),e.ctrlKey?(clearTimeout(this._ctrlKeyTimeout),this._ctrlKeyTimeout=-1,t.ctrlKey=!0):!e.ctrlKey&&t.ctrlKey&&-1===this._ctrlKeyTimeout&&(this._ctrlKeyTimeout=this.timers.setTimeout(this._setCtrlKeyTimeout,150)),e.metaKey?(clearTimeout(this._metaKeyTimeout),this._metaKeyTimeout=-1,t.metaKey=!0):!e.metaKey&&t.metaKey&&-1===this._metaKeyTimeout&&(this._metaKeyTimeout=this.timers.setTimeout(this._setMetaKeyTimeout,150));let{originPagePoint:s,currentPagePoint:r}=t;t.isPointing||(t.isDragging=!1);let n=this.store.unsafeGetWithoutCapture(eB.PQ),a=this.store.get(this._getCurrentPageStateId()),h=this._cameraOptions.__unsafe__getWithoutCapture();switch(i){case"pinch":if(h.isLocked)return;switch(clearTimeout(this._longPressTimeout),this._updateInputsFromEvent(e),e.name){case"pinch_start":if(t.isPinching)return;t.isEditing||(this._pinchStart=this.getCamera().z,this._selectedShapeIdsAtPointerDown.length||(this._selectedShapeIdsAtPointerDown=[...a.selectedShapeIds]),this._didPinch=!0,t.isPinching=!0,this.interrupt());return;case"pinch":{if(!t.isPinching)return;let{point:{z:i=1},delta:{x:s,y:r}}=e,{x:a,y:o}=eV.B.SubXY(e.point,n.screenBounds.x,n.screenBounds.y);this.stopCameraAnimation(),n.followingUserId&&this.stopFollowingUser();let{x:p,y:l,z:g}=(0,ex.dy)(()=>this.getCamera()),{panSpeed:d,zoomSpeed:u}=h;this._setCamera(new eV.B(p+s*d/g-a/g+a/(i*u),l+r*d/g-o/g+o/(i*u),i*u),{immediate:!0});return}case"pinch_end":{if(!t.isPinching)return this;t.isPinching=!1;let{_selectedShapeIdsAtPointerDown:e}=this;this.setSelectedShapes(this._selectedShapeIdsAtPointerDown),this._selectedShapeIdsAtPointerDown=[],this._didPinch&&(this._didPinch=!1,e.length>0&&this.once("tick",()=>{this._didPinch||this.setSelectedShapes(e)}));return}}case"wheel":{if(h.isLocked)return;this._updateInputsFromEvent(e);let{panSpeed:i,zoomSpeed:s,wheelBehavior:r}=h;if("none"!==r){this.stopCameraAnimation(),n.followingUserId&&this.stopFollowingUser();let{x:a,y:h,z:o}=(0,ex.dy)(()=>this.getCamera()),{x:p,y:l,z:g=0}=e.delta,d=r;switch(t.ctrlKey&&(d="pan"===r?"zoom":"pan"),d){case"zoom":{let{x:e,y:t}=this.inputs.currentScreenPoint,i=g;"zoom"===r&&(i=Math.abs(l)>10?10*Math.sign(l)/100:l/100);let n=o+(i??0)*s*o;this._setCamera(new eV.B(a+(e/n-e)-(e/o-e),h+(t/n-t)-(t/o-t),n),{immediate:!0}),this.maybeTrackPerformance("Zooming");return}case"pan":this._setCamera(new eV.B(a+p*i/o,h+l*i/o,o),{immediate:!0}),this.maybeTrackPerformance("Panning");return}}break}case"pointer":{if(t.isPinching)return;this._updateInputsFromEvent(e);let{isPen:i}=e,{isPenMode:a}=n;switch(e.name){case"pointer_down":if(a&&!i)return;if(this.inputs.isPanning||(this._longPressTimeout=this.timers.setTimeout(()=>{this.dispatch({...e,point:this.inputs.currentScreenPoint,name:"long_press"})},this.options.longPressDurationMs)),this._selectedShapeIdsAtPointerDown=this.getSelectedShapeIds(),e.button===eO.QN&&(this.capturedPointerId=e.pointerId),t.buttons.add(e.button),t.isPointing=!0,t.isDragging=!1,!a&&i&&this.updateInstanceState({isPenMode:!0}),e.button===eO.an?(this._restoreToolId=this.getCurrentToolId(),this.complete(),this.setCurrentTool("eraser")):e.button===eO.sz&&(this.inputs.isPanning||(this._prevCursor=this.getInstanceState().cursor.type),this.inputs.isPanning=!0,clearTimeout(this._longPressTimeout)),this.inputs.isPanning)return this.stopCameraAnimation(),this.setCursor({type:"grabbing",rotation:0}),this;break;case"pointer_move":{if(!i&&a)return;let{x:e,y:o,z:p}=(0,ex.dy)(()=>this.getCamera());if(this.inputs.isPanning&&this.inputs.isPointing){let{currentScreenPoint:t,previousScreenPoint:i}=this.inputs,{panSpeed:s}=h,r=eV.B.Sub(t,i);this.setCamera(new eV.B(e+r.x*s/p,o+r.y*s/p,p),{immediate:!0}),this.maybeTrackPerformance("Panning");return}t.isPointing&&!t.isDragging&&eV.B.Dist2(s,r)*this.getZoomLevel()>(n.isCoarsePointer?this.options.coarseDragDistanceSquared:this.options.dragDistanceSquared)/p&&(t.isDragging=!0,clearTimeout(this._longPressTimeout));break}case"pointer_up":if(t.isDragging=!1,t.isPointing=!1,clearTimeout(this._longPressTimeout),t.buttons.delete(e.button),n.isPenMode&&!i)return;if(this.capturedPointerId===e.pointerId&&(this.capturedPointerId=null,e.button=0),t.isPanning){t.keys.has("Space")||(t.isPanning=!1,t.isSpacebarPanning=!1);let i=this.inputs.pointerVelocity,s=Math.min(2,i.len());switch(e.button){case eO.QN:this.setCursor({type:"grab",rotation:0});break;case eO.sz:this.inputs.keys.has(" ")?this.setCursor({type:"grab",rotation:0}):this.setCursor({type:this._prevCursor,rotation:0})}s>0&&this.slideCamera({speed:s,direction:i})}else e.button===eO.an&&(this.complete(),this.setCurrentTool(this._restoreToolId))}break}case"keyboard":switch("ShiftRight"===e.key&&(e.key="ShiftLeft"),"AltRight"===e.key&&(e.key="AltLeft"),"ControlRight"===e.code&&(e.code="ControlLeft"),"MetaRight"===e.code&&(e.code="MetaLeft"),e.name){case"key_down":if(t.keys.add(e.code),"Space"!==e.code||e.ctrlKey||(this.inputs.isPanning||(this._prevCursor=n.cursor.type),this.inputs.isPanning=!0,this.inputs.isSpacebarPanning=!0,clearTimeout(this._longPressTimeout),this.setCursor({type:this.inputs.isPointing?"grabbing":"grab",rotation:0})),this.inputs.isSpacebarPanning){let t;switch(e.code){case"ArrowUp":t=new eV.B(0,-1);break;case"ArrowRight":t=new eV.B(1,0);break;case"ArrowDown":t=new eV.B(0,1);break;case"ArrowLeft":t=new eV.B(-1,0)}if(t){let e=this.getViewportPageBounds(),i=e.clone().translate(t.mulV({x:e.w,y:e.h}));this._animateToViewport(i,{animation:{duration:320}})}}break;case"key_up":t.keys.delete(e.code),"Space"===e.code&&(this.inputs.buttons.has(eO.sz)||(this.inputs.isPanning=!1,this.inputs.isSpacebarPanning=!1,this.setCursor({type:this._prevCursor,rotation:0})))}}if("pointer"===e.type){e.button===eO.sz?e.name="middle_click":e.button===eO.Hs&&(e.name="right_click");let{isPenMode:t}=this.store.unsafeGetWithoutCapture(eB.PQ);if(e.isPen===t){let t=this._clickManager.handlePointerEvent(e);if(e.name!==t.name){this.root.handleEvent(e),this.emit("event",e),this.root.handleEvent(t),this.emit("event",t);return}}}return this.root.handleEvent(e),this.emit("event",e),"pointer"===e.type&&"pointer_down"===e.name&&this.menus.clearOpenMenus(),this}maybeTrackPerformance(e){ej.hR.measurePerformance.get()&&(this.performanceTracker.isStarted()?clearTimeout(this.performanceTrackerTimeout):this.performanceTracker.start(e),this.performanceTrackerTimeout=this.timers.setTimeout(()=>{this.performanceTracker.stop()},50))}}function tx(e,t=e.getCurrentPageId()){let i=e.getPage(t).name;e.emit("max-shapes",{name:i,pageId:t,count:e.options.maxShapesPerPage})}function tT(e,t){if(!t)return e;let i=null,s=Object.entries(t);for(let t=0,r=s.length;t<r;t++){let[r,n]=s[t];if(void 0!==n&&"id"!==r&&"type"!==r&&"typeName"!==r&&n!==e[r]){if(i||(i={...e}),"props"===r||"meta"===r){for(let[t,s]of(i[r]={...e[r]},Object.entries(n)))void 0!==s&&(i[r][t]=s);continue}i[r]=n}}return i||e}function tB(e,t,i){let s;if(e.run(()=>{let r=e.store.extractingChanges(()=>{let r=new Set,n=new Set;for(let i of t)if(e.getShape(i))for(let s of e.getBindingsInvolvingShape(i)){let e=t.has(s.fromId),i=t.has(s.toId);if(e&&i){r.add(s.id);continue}e&&i||n.add(s.id)}e.deleteBindings([...n],{isolateShapes:!0});try{s=eb.x4.ok(i(r))}catch(e){s=eb.x4.err(e)}});e.store.applyDiff((0,eT.kJ)(r))},{history:"ignore"}),s.ok)return s.value;throw s.error}function tb(e,t){if(!t.constraints)throw Error("Should have constraints here");let{padding:{x:i,y:s}}=t.constraints,r=e.getViewportScreenBounds(),n=ez.xu.From(t.constraints.bounds);return{zx:(r.w-2*i)/n.w,zy:(r.h-2*s)/n.h}}tf(e_=[,,,tr(ew?.[th("metadata")]??null)],1,"getIsShapeHiddenCache",eC,t_),tf(e_,1,"getCanUndo",eI,t_),tf(e_,1,"getCanRedo",eP,t_),tf(e_,1,"getPath",ey,t_),tf(e_,1,"getCurrentTool",em,t_),tf(e_,1,"getCurrentToolId",ef,t_),tf(e_,1,"getDocumentSettings",eS,t_),tf(e_,1,"getInstanceState",ec,t_),tf(e_,1,"getOpenMenus",eu,t_),tf(e_,1,"getIsMenuOpen",ed,t_),tf(e_,1,"getPageStates",eg,t_),tf(e_,1,"_getPageStatesQuery",el,t_),tf(e_,1,"getCurrentPageState",ep,t_),tf(e_,1,"_getCurrentPageStateId",eo,t_),tf(e_,1,"getSelectedShapeIds",eh,t_),tf(e_,1,"getSelectedShapes",ea,t_),tf(e_,1,"getOnlySelectedShapeId",en,t_),tf(e_,1,"getOnlySelectedShape",er,t_),tf(e_,1,"getSelectionPageBounds",es,t_),tf(e_,1,"getSelectionRotation",ei,t_),tf(e_,1,"getSelectionRotatedPageBounds",et,t_),tf(e_,1,"getSelectionRotatedScreenBounds",ee,t_),tf(e_,1,"getFocusedGroupId",J,t_),tf(e_,1,"getFocusedGroup",W,t_),tf(e_,1,"getEditingShapeId",$,t_),tf(e_,1,"getEditingShape",Q,t_),tf(e_,1,"getHoveredShapeId",q,t_),tf(e_,1,"getHoveredShape",j,t_),tf(e_,1,"getHintingShapeIds",X,t_),tf(e_,1,"getHintingShape",N,t_),tf(e_,1,"getErasingShapeIds",Y,t_),tf(e_,1,"getErasingShapes",Z,t_),tf(e_,1,"_unsafe_getCameraId",G,t_),tf(e_,1,"getCamera",H,t_),tf(e_,1,"getViewportPageBoundsForFollowing",V,t_),tf(e_,1,"getCameraForFollowing",D,t_),tf(e_,1,"getZoomLevel",z,t_),tf(e_,1,"getViewportScreenBounds",R,t_),tf(e_,1,"getViewportScreenCenter",L,t_),tf(e_,1,"getViewportPageBounds",K,t_),tf(e_,1,"_getCollaboratorsQuery",U,t_),tf(e_,1,"getCollaborators",E,t_),tf(e_,1,"getCollaboratorsOnCurrentPage",O,t_),tf(e_,1,"getRenderingShapes",M,t_),tf(e_,1,"_getAllPagesQuery",A,t_),tf(e_,1,"getPages",F,t_),tf(e_,1,"getCurrentPageId",k,t_),tf(e_,1,"getCurrentPageShapeIdsSorted",v,t_),tf(e_,1,"_getAllAssetsQuery",b,t_),tf(e_,1,"_getShapeGeometryCache",B,t_),tf(e_,1,"_getShapeHandlesCache",T,t_),tf(e_,1,"_getShapePageTransformCache",_,t_),tf(e_,1,"_getShapePageBoundsCache",w,t_),tf(e_,1,"_getShapeClipPathCache",C,t_),tf(e_,1,"_getShapeMaskCache",I,t_),tf(e_,1,"_getShapeMaskedPageBoundsCache",P,t_),tf(e_,1,"_notVisibleShapes",y,t_),tf(e_,1,"getCulledShapes",m,t_),tf(e_,1,"getCurrentPageBounds",f,t_),tf(e_,1,"getCurrentPageShapes",S,t_),tf(e_,1,"getCurrentPageShapesSorted",c,t_),tf(e_,1,"getCurrentPageRenderingShapesSorted",u,t_),tf(e_,1,"_getBindingsIndexCache",d,t_),tf(e_,1,"_getSelectionSharedStyles",g,t_),tf(e_,1,"getSharedStyles",l,t_),tf(e_,1,"getSharedOpacity",p,t_),tf(e_,1,"getIsFocused",o,t_),tf(e_,1,"getIsReadonly",h,t_),tf(e_,1,"_setShiftKeyTimeout",a,t_),tf(e_,1,"_setAltKeyTimeout",n,t_),tf(e_,1,"_setCtrlKeyTimeout",r,t_),tf(e_,1,"_setMetaKeyTimeout",s,t_),tc(e_,t_)}}]);