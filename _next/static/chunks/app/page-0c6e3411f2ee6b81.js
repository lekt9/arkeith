(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{34143:(e,t,r)=>{Promise.resolve().then(r.bind(r,76774))},76774:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>h});var o=r(57437),n=r(48059),a=r.n(n),s=r(2265),i=r(92993),l=r(68257);r(1398);var d=r(42223);let p=(e,t)=>Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2)),c=e=>{let{onShapesChange:t}=e,r=(0,l.jE2)(),o=(0,s.useRef)(new Map);return(0,s.useEffect)(()=>{if(!r)return()=>{};let e=()=>{let e=new Map,n=r.getCurrentPageShapes().filter(e=>{var t;return"text"in e.props&&r.isShapeOfType(e,"text")&&(null===(t=e.props.text)||void 0===t?void 0:t.trim())}),a=!1;n.forEach(t=>{let n=r.getShapePageBounds(t);if(n){let r={text:t.props.text||"",center:n.center};e.set(t.id,r);let s=o.current.get(t.id);s&&s.text===r.text&&s.center.x===r.center.x&&s.center.y===r.center.y||(a=!0)}}),o.current.size!==e.size&&(a=!0),a&&(o.current=e,t(e))};return r.addListener("change",e),()=>{r.removeListener("change",e)}},[r,t]),null},g=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3;try{return await (0,i.ke)(e)}catch(r){if(t>0)return await new Promise(e=>setTimeout(e,1e3)),g(e,t-1);throw r}},u="tldraw-whiteboard-state",f=()=>(0,o.jsxs)("div",{style:{display:"inline-flex",marginLeft:"8px",verticalAlign:"middle"},className:"jsx-b31678e7f5f56372",children:[(0,o.jsx)(a(),{id:"b31678e7f5f56372",children:"@-webkit-keyframes spin{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@-moz-keyframes spin{0%{-moz-transform:rotate(0deg);transform:rotate(0deg)}100%{-moz-transform:rotate(360deg);transform:rotate(360deg)}}@-o-keyframes spin{0%{-o-transform:rotate(0deg);transform:rotate(0deg)}100%{-o-transform:rotate(360deg);transform:rotate(360deg)}}@keyframes spin{0%{-webkit-transform:rotate(0deg);-moz-transform:rotate(0deg);-o-transform:rotate(0deg);transform:rotate(0deg)}100%{-webkit-transform:rotate(360deg);-moz-transform:rotate(360deg);-o-transform:rotate(360deg);transform:rotate(360deg)}}.spinner.jsx-b31678e7f5f56372{width:12px;height:12px;border:2px solid currentColor;border-right-color:transparent;-webkit-border-radius:50%;-moz-border-radius:50%;border-radius:50%;-webkit-animation:spin.75s linear infinite;-moz-animation:spin.75s linear infinite;-o-animation:spin.75s linear infinite;animation:spin.75s linear infinite}"}),(0,o.jsx)("div",{className:"jsx-b31678e7f5f56372 spinner"})]});function h(){let[e,t]=(0,s.useState)(""),[r,n]=(0,s.useState)([]),[a,h]=(0,s.useState)(null),m=(0,s.useRef)(null),[b]=(0,s.useState)(()=>(0,l.jx$)()),[y,w]=(0,s.useState)(!1),[S,v]=(0,s.useState)({status:"loading"}),[k,C]=(0,s.useState)(!1),[j,I]=(0,s.useState)([]),[R,A]=(0,s.useState)(""),B=new d.ZP({apiKey:"",dangerouslyAllowBrowser:!0}),[z,P]=(0,s.useState)(!1),[M,O]=(0,s.useState)(()=>{{let e=localStorage.getItem("whiteboard-settings");return e?JSON.parse(e):{groqApiKey:""}}}),[E,K]=(0,s.useState)(null);(0,s.useEffect)(()=>{try{let e=localStorage.getItem(u);if(e){let t=JSON.parse(e);b.loadSnapshot(t)}v({status:"ready"})}catch(e){v({status:"error",error:e.message})}},[b]),(0,s.useEffect)(()=>{if(!a)return;let e=a.store.listen(()=>{try{let e=a.store.getSnapshot();localStorage.setItem(u,JSON.stringify(e)),console.log("Saved whiteboard state to localStorage")}catch(e){console.error("Failed to save whiteboard state:",e)}});return()=>{e()}},[a]),(0,s.useEffect)(()=>{m.current=new i.pV,m.current.getAllObjectsFromIndexedDB("indexedDB").catch(console.error)},[]);let T=async e=>{if(!m.current||!a)return;console.log("Starting index update...");let t=new Map((await m.current.getAllObjectsFromIndexedDB("indexedDB")).map(e=>[e.shapeId,e]));for(let r of Array.from(e.entries()).map(e=>{let[t,r]=e;return{id:t,text:r.text,center:r.center}}).reduce((e,t)=>{let r=e.find(e=>200>p(t.center,e.center));return r?(r.shapes.push(t),r.center={x:r.shapes.reduce((e,t)=>e+t.center.x,0)/r.shapes.length,y:r.shapes.reduce((e,t)=>e+t.center.y,0)/r.shapes.length}):e.push({shapes:[t],center:t.center}),e},[])){let e=r.shapes.map(e=>e.text.trim()).filter(Boolean).join(" ");if(e)try{let o=r.shapes.map(e=>t.get(e.id)).filter(Boolean);if(o.length>0)for(let t of(console.log("Found existing embeddings for cluster:",{text:e,count:o.length}),o))await m.current.remove({id:t.id}),console.log("Removed old embedding:",{id:t.id,text:t.name,shapeId:t.shapeId});let n=await g(e),a={id:"cluster-".concat(Date.now(),"-").concat(Math.random()),name:e,embedding:n,shapeId:r.shapes[0].id};await m.current.add(a),console.log("Added/Updated embedding:",{text:e,shapeId:a.shapeId})}catch(e){console.error("Failed to process cluster:",e)}}await m.current.saveIndex("indexedDB"),console.log("Index update completed")},D=e=>{if(!a)return;let t=a.getShape(e.shapeId);if(t){let r=a.getShapePageBounds(t);r&&(a.centerOnPoint(r.center),a.select(t.id),console.log("Navigated to shape:",{text:e.name,shapeId:e.shapeId,currentPosition:r.center}))}else console.log("Shape not found:",e.shapeId)},L={width:2560,height:1440},q=async e=>{if(!a||0===e.length)return null;try{let t=e.map(e=>e.position),r=[...t].sort((e,t)=>e.x-t.x),o=[...t].sort((e,t)=>e.y-t.y),n=r[Math.floor(t.length/2)].x,s=o[Math.floor(t.length/2)].y,i=new l.xuv(n-L.width/2,s-L.height/2,L.width,L.height),d=a.getCurrentPageShapes().filter(e=>{let t=a.getShapeMaskedPageBounds(e);return!!t&&i.includes(t)});if(0===d.length)return null;let p=await (0,l.Flc)({editor:a,ids:d.map(e=>e.id),format:"png",opts:{bounds:i,background:a.getInstanceState().exportBackground}});return new Promise((e,t)=>{let r=new FileReader;r.onloadend=()=>e(r.result),r.onerror=t,r.readAsDataURL(p)})}catch(e){return console.error("Failed to capture area:",e),null}},N=async(e,t,r)=>{if(!M.groqApiKey)throw Error("Please set your GROQ API key in settings");try{var o,n;let a=[];a.push({role:"user",content:"You are an AI assistant helping to analyze and discuss content from a whiteboard. The user's query is related to the following content found on the whiteboard, make sense of it and assume that this part is just text extracted from the whiteboard - ignore gibberish:\n\n".concat(t)}),a.push(...e.map(e=>({role:e.role,content:e.content}))),r&&a.push({role:"user",content:[{type:"text",text:"Here is the relevant section of the whiteboard:"+t},{type:"image_url",image_url:{url:r}}]}),console.log("Sending messages to GROQ:",{messageCount:a.length,hasImage:!!r,searchContext:t.substring(0,100)+"..."});let s=await B.chat.completions.create({messages:a,model:"llama-3.2-11b-vision-preview",temperature:.7,max_tokens:2048,top_p:1,stream:!1});return(null===(n=s.choices[0])||void 0===n?void 0:null===(o=n.message)||void 0===o?void 0:o.content)||"No response generated"}catch(e){throw console.error("Error generating chat response:",e),e}},_=async()=>{if(R.trim()&&a&&m.current){if(!M.groqApiKey){I(e=>[...e,{role:"assistant",content:"Please set your GROQ API key in settings first."}]);return}A(""),I(e=>[...e,{role:"user",content:R,isLoading:!0}]),w(!0),B.apiKey=M.groqApiKey;try{let e=await g(R),t=await m.current.search(e,{topK:100,useStorage:"indexedDB"}),r=t.map(e=>{let t=a.getShape(e.object.shapeId),r=t&&"text"in t.props?t.props.text:"";return"\n".concat(r)}).join("\n\n");console.log("Search context:",r);let o=t.map(e=>{let t=a.getShape(e.object.shapeId);if(!t)return null;let r=a.getShapePageBounds(t);return r?{shape:t,position:r.center,similarity:e.similarity}:null}).filter(Boolean),n=null;if(o.length>0){n=await q(o),K(n);let e=o.sort((e,t)=>e.position.x-t.position.x)[Math.floor(o.length/2)].position.x,t=o.sort((e,t)=>e.position.y-t.position.y)[Math.floor(o.length/2)].position.y;a.centerOnPoint(new l.B08(e,t))}else K(null);let s=await N([...j,{role:"user",content:R,isLoading:!0}],r,n);I(e=>e.map((t,r)=>r===e.length-1?{...t,isLoading:!1}:t)),I(e=>[...e,{role:"assistant",content:s}])}catch(e){console.error("Error during chat:",e),I(e=>[...e.slice(0,-1),{...e[e.length-1],isLoading:!1},{role:"assistant",content:"Sorry, there was an error processing your message."}])}finally{w(!1)}}};(0,s.useEffect)(()=>{M.groqApiKey&&(B.apiKey=M.groqApiKey,console.log("Initialized GROQ with API key from settings"))},[M.groqApiKey]);let F=e=>{O(e),localStorage.setItem("whiteboard-settings",JSON.stringify(e)),B.apiKey=e.groqApiKey};return(0,o.jsxs)("div",{style:x.container,children:[(0,o.jsxs)("div",{style:x.mainContent,children:[(0,o.jsxs)("div",{style:x.searchContainer,children:[(0,o.jsx)("input",{type:"text",value:e,onChange:e=>t(e.target.value),placeholder:"Search within whiteboard...",style:x.input}),(0,o.jsx)("button",{type:"submit",style:x.button,children:"Search"}),(0,o.jsx)("button",{type:"button",onClick:()=>P(!z),style:x.settingsButton,children:"⚙️ Settings"})]}),z&&(0,o.jsxs)("div",{style:x.settingsPane,children:[(0,o.jsx)("h3",{style:x.settingsTitle,children:"Settings"}),(0,o.jsx)("div",{style:x.settingGroup,children:(0,o.jsxs)("label",{style:x.settingLabel,children:["GROQ API Key:",(0,o.jsx)("input",{type:"password",value:M.groqApiKey,onChange:e=>F({...M,groqApiKey:e.target.value}),placeholder:"Enter your GROQ API key",style:x.settingInput})]})}),(0,o.jsx)("div",{style:x.settingHelp,children:"Your API key is stored locally and never sent to any server except GROQ."})]}),r.length>0&&(0,o.jsxs)("div",{style:x.resultsContainer,children:[(0,o.jsx)("h3",{style:x.resultsTitle,children:"Results:"}),(0,o.jsx)("ul",{style:x.resultsList,children:r.map(e=>(0,o.jsx)("li",{style:x.resultItem,onClick:()=>D(e),onMouseEnter:e=>{e.currentTarget.style.backgroundColor="#f0f0f0",e.currentTarget.style.cursor="pointer"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="#ffffff"},children:e.name},e.id))})]}),(0,o.jsx)("div",{style:x.whiteboard,children:"error"===S.status?(0,o.jsxs)("div",{style:x.errorMessage,children:["Error loading whiteboard: ",S.error]}):(0,o.jsx)(l.DrV,{store:b,onMount:h,autoFocus:!0,children:(0,o.jsx)(c,{onShapesChange:T})})})]}),(0,o.jsxs)("div",{style:x.chatSidebar,children:[(0,o.jsx)("div",{style:x.chatHeader,children:(0,o.jsx)("h3",{style:x.chatTitle,children:"Chat"})}),(0,o.jsxs)("div",{style:x.messagesContainer,children:[j.map((e,t)=>(0,o.jsx)("div",{style:"user"===e.role?x.userMessage:x.assistantMessage,children:(0,o.jsxs)("div",{style:x.messageContent,children:[e.content,e.isLoading&&(0,o.jsx)(f,{})]})},t)),E&&(0,o.jsx)("div",{style:x.screenshotContainer,children:(0,o.jsx)("img",{src:E,alt:"Current context",style:x.screenshot,onClick:()=>{window.open(E,"_blank")}})})]}),(0,o.jsxs)("form",{style:x.chatInputContainer,onSubmit:e=>{e.preventDefault(),y||_()},children:[(0,o.jsx)("input",{type:"text",value:R,onChange:e=>A(e.target.value),placeholder:y?"Processing...":"Ask about your whiteboard...",style:x.chatInput,disabled:y}),(0,o.jsx)("button",{type:"submit",style:{...x.chatButton,opacity:y?.7:1,cursor:y?"not-allowed":"pointer"},disabled:y,children:"Send"})]})]})]})}let x={container:{height:"100vh",display:"flex",gap:"10px",padding:"10px",backgroundColor:"#ffffff"},mainContent:{flex:1,display:"flex",flexDirection:"column",gap:"10px",minWidth:0},chatSidebar:{width:"300px",display:"flex",flexDirection:"column",backgroundColor:"#f5f5f5",borderRadius:"8px",boxShadow:"-2px 0 5px rgba(0,0,0,0.1)"},chatHeader:{padding:"15px",borderBottom:"1px solid #ddd"},chatTitle:{margin:0,color:"#333",fontSize:"16px",fontWeight:"500"},messagesContainer:{flex:1,overflowY:"auto",padding:"10px",display:"flex",flexDirection:"column",gap:"10px"},userMessage:{alignSelf:"flex-end",backgroundColor:"#0066cc",color:"#ffffff",padding:"8px 12px",borderRadius:"12px 12px 0 12px",maxWidth:"85%",boxShadow:"0 2px 4px rgba(0,0,0,0.1)"},assistantMessage:{alignSelf:"flex-start",backgroundColor:"#ffffff",color:"#000000",padding:"8px 12px",borderRadius:"12px 12px 12px 0",maxWidth:"85%",boxShadow:"0 2px 4px rgba(0,0,0,0.1)"},messageContent:{marginBottom:"8px",wordBreak:"break-word",color:"inherit",fontSize:"14px",lineHeight:"1.4"},screenshotContainer:{position:"relative",width:"100%",borderRadius:"4px",overflow:"hidden",cursor:"pointer"},screenshot:{width:"100%",height:"auto",display:"block",transition:"transform 0.2s ease","&:hover":{transform:"scale(1.02)"}},chatInputContainer:{padding:"10px",borderTop:"1px solid #ddd",display:"flex",gap:"8px"},chatInput:{padding:"8px 12px",fontSize:"16px",flex:1,borderRadius:"4px",border:"1px solid #ddd",backgroundColor:"#ffffff",color:"#000000","::placeholder":{color:"#666666"}},chatButton:{padding:"8px 16px",fontSize:"14px",cursor:"pointer",backgroundColor:"#0066cc",color:"white",border:"none",borderRadius:"20px",fontWeight:"500","&:hover":{backgroundColor:"#0052a3"}},searchContainer:{display:"flex",alignItems:"center",gap:"10px",padding:"10px",backgroundColor:"#f5f5f5",borderRadius:"8px",boxShadow:"0 2px 4px rgba(0,0,0,0.1)"},input:{padding:"8px 12px",fontSize:"16px",flex:1,borderRadius:"4px",border:"1px solid #ddd",backgroundColor:"#ffffff",color:"#000000","::placeholder":{color:"#666666"}},button:{padding:"8px 16px",fontSize:"14px",cursor:"pointer",backgroundColor:"#0066cc",color:"white",border:"none",borderRadius:"4px",fontWeight:"500"},resultsContainer:{padding:"15px",backgroundColor:"#ffffff",borderRadius:"8px",maxHeight:"150px",overflowY:"auto",boxShadow:"0 2px 4px rgba(0,0,0,0.1)",border:"1px solid #e0e0e0"},resultsList:{listStyle:"none",padding:0,margin:0},resultItem:{padding:"8px 12px",borderBottom:"1px solid #e0e0e0",color:"#000000",fontSize:"14px",lineHeight:"1.4",backgroundColor:"#ffffff",transition:"background-color 0.2s ease",userSelect:"none","&:last-child":{borderBottom:"none"},"&:hover":{backgroundColor:"#f8f8f8"}},resultsTitle:{margin:"0 0 10px 0",color:"#333333",fontSize:"16px",fontWeight:"500"},whiteboard:{flex:1,borderRadius:"8px",overflow:"hidden",border:"1px solid #ddd",backgroundColor:"#ffffff"},errorMessage:{padding:"20px",color:"#ff4d4d",textAlign:"center",backgroundColor:"#fff",border:"1px solid #ff4d4d",borderRadius:"8px",margin:"20px"},settingsButton:{padding:"8px 16px",fontSize:"14px",backgroundColor:"#666666",color:"#fff",border:"none",borderRadius:"4px",cursor:"pointer",fontWeight:"500",display:"flex",alignItems:"center",gap:"4px"},settingsPane:{position:"absolute",top:"60px",right:"320px",width:"300px",backgroundColor:"#ffffff",borderRadius:"8px",boxShadow:"0 2px 8px rgba(0,0,0,0.2)",padding:"16px",zIndex:1e3},settingsTitle:{margin:"0 0 16px 0",color:"#333333",fontSize:"16px",fontWeight:"500"},settingGroup:{marginBottom:"16px"},settingLabel:{display:"flex",flexDirection:"column",gap:"4px",color:"#333333",fontSize:"14px"},settingInput:{padding:"8px 12px",fontSize:"14px",borderRadius:"4px",border:"1px solid #ddd",backgroundColor:"#ffffff",color:"#000000",width:"100%",marginTop:"4px"},settingHelp:{fontSize:"12px",color:"#666666",marginTop:"4px"}}}},e=>{var t=t=>e(e.s=t);e.O(0,[574,155,191,130,215,744],()=>t(34143)),_N_E=e.O()}]);